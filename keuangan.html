<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mockup Aplikasi Sekolah - Manajemen Keuangan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        .modal { transition: opacity 0.25s ease; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="flex h-screen">
        <aside class="w-64 bg-white shadow-md hidden md:block">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800">App Sekolah</h2>
                <p class="text-sm text-gray-500">Versi 1.0</p>
            </div>
            <nav class="mt-6">
                <a href="#" class="flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200">
                    <ion-icon name="grid-outline" class="w-5 h-5"></ion-icon>
                    <span class="mx-4">Dashboard</span>
                </a>
                <a href="#" class="flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200">
                    <ion-icon name="people-outline" class="w-5 h-5"></ion-icon>
                    <span class="mx-4">PPDB</span>
                </a>
                <a href="#" class="flex items-center px-6 py-3 bg-blue-500 text-white font-semibold">
                    <ion-icon name="wallet-outline" class="w-5 h-5"></ion-icon>
                    <span class="mx-4">Keuangan</span>
                </a>
                <a href="#" class="flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200">
                    <ion-icon name="checkmark-done-outline" class="w-5 h-5"></ion-icon>
                    <span class="mx-4">Absensi Siswa</span>
                </a>
                <a href="#" class="flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200">
                    <ion-icon name="alert-circle-outline" class="w-5 h-5"></ion-icon>
                    <span class="mx-4">Pelanggaran</span>
                </a>
            </nav>
        </aside>

        <main class="flex-1 p-6 md:p-10 overflow-y-auto">
            <header>
                <h1 class="text-3xl font-bold text-gray-900">Manajemen Keuangan Sekolah</h1>
                <p class="text-gray-600 mt-1">Pantau status pembayaran, catat transaksi, dan lihat rekapitulasi keuangan.</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                <div class="bg-white p-6 rounded-lg shadow-lg flex items-center">
                    <div class="bg-green-100 p-3 rounded-full"><ion-icon name="cash-outline" class="text-3xl text-green-600"></ion-icon></div>
                    <div class="ml-4">
                        <p class="text-gray-500">Total Pemasukan</p>
                        <p id="totalIncome" class="text-2xl font-bold text-gray-900">Rp 0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg flex items-center">
                    <div class="bg-red-100 p-3 rounded-full"><ion-icon name="document-text-outline" class="text-3xl text-red-600"></ion-icon></div>
                    <div class="ml-4">
                        <p class="text-gray-500">Total Tunggakan</p>
                        <p id="totalOutstanding" class="text-2xl font-bold text-gray-900">Rp 0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg flex items-center">
                    <div class="bg-blue-100 p-3 rounded-full"><ion-icon name="checkmark-circle-outline" class="text-3xl text-blue-600"></ion-icon></div>
                    <div class="ml-4">
                        <p class="text-gray-500">Siswa Lunas</p>
                        <p id="paidOffStudents" class="text-2xl font-bold text-gray-900">0 / 0</p>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">Status Pembayaran Siswa</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Nama Siswa</th>
                                <th scope="col" class="px-6 py-3">Kelas</th>
                                <th scope="col" class="px-6 py-3">Total Tagihan</th>
                                <th scope="col" class="px-6 py-3">Total Terbayar</th>
                                <th scope="col" class="px-6 py-3">Sisa Tunggakan</th>
                                <th scope="col" class="px-6 py-3">Status</th>
                                <th scope="col" class="px-6 py-3">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentFinanceTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="paymentDetailModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                <div>
                    <h3 id="modalTitle" class="text-2xl font-bold">Detail Pembayaran</h3>
                    <p id="modalStudentInfo" class="text-gray-600"></p>
                </div>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-grow grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                    <h4 class="font-bold text-lg mb-4">Riwayat Pembayaran</h4>
                    <div id="paymentHistoryContainer" class="overflow-auto" style="max-height: 400px;">
                        </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-bold text-lg mb-4">Catat Pembayaran Baru</h4>
                    <form id="newPaymentForm">
                        <input type="hidden" id="currentStudentId">
                        <input type="hidden" id="paymentId">

                        <div class="mb-4">
                            <label for="paymentType" class="block text-gray-700 text-sm font-bold mb-2">Jenis Pembayaran:</label>
                            <select id="paymentType" class="shadow border rounded w-full py-2 px-3" required></select>
                        </div>
                        <div class="mb-4">
                            <label for="paymentAmount" class="block text-gray-700 text-sm font-bold mb-2">Jumlah Bayar (Rp):</label>
                            <input type="number" id="paymentAmount" class="shadow border rounded w-full py-2 px-3" required>
                        </div>
                         <div class="mb-4">
                            <label for="paymentMethod" class="block text-gray-700 text-sm font-bold mb-2">Metode Bayar:</label>
                            <select id="paymentMethod" class="shadow border rounded w-full py-2 px-3" required>
                                <option>Transfer Bank</option>
                                <option>Cash</option>
                                <option>QRIS</option>
                            </select>
                        </div>
                         <div class="mb-4">
                            <label for="paymentDate" class="block text-gray-700 text-sm font-bold mb-2">Tanggal Bayar:</label>
                            <input type="date" id="paymentDate" class="shadow border rounded w-full py-2 px-3" required>
                        </div>
                        <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Simpan Pembayaran</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Elemen DOM ---
        const studentFinanceTableBody = document.getElementById('studentFinanceTableBody');
        const modal = document.getElementById('paymentDetailModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const newPaymentForm = document.getElementById('newPaymentForm');
        
        // --- State Aplikasi & Data Master ---
        const LOCAL_STORAGE_KEY = 'schoolFinanceData';
        
        const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);

        const getInitialData = () => [
            {
                id: '101', nama: 'Budi Santoso', kelas: '10 IPA 1',
                tagihan: [
                    { id: 't1', deskripsi: 'SPP Agustus 2025', jumlah: 500000 },
                    { id: 't2', deskripsi: 'Uang Buku Semester 1', jumlah: 750000 },
                    { id: 't3', deskripsi: 'Uang Kegiatan 17an', jumlah: 50000 }
                ],
                pembayaran: [
                    { id: Date.now() + 1, tanggal: '2025-08-05', deskripsi: 'SPP Agustus 2025', jumlah: 500000, metode: 'Transfer Bank' }
                ]
            },
            {
                id: '102', nama: 'Ani Lestari', kelas: '11 IPS 2',
                tagihan: [
                    { id: 't4', deskripsi: 'SPP Agustus 2025', jumlah: 550000 },
                    { id: 't5', deskripsi: 'Uang Study Tour', jumlah: 1200000 },
                ],
                pembayaran: [
                    { id: Date.now() + 2, tanggal: '2025-08-10', deskripsi: 'Uang Study Tour', jumlah: 1200000, metode: 'Cash' },
                    { id: Date.now() + 3, tanggal: '2025-08-10', deskripsi: 'SPP Agustus 2025', jumlah: 550000, metode: 'Cash' }
                ]
            },
            {
                id: '103', nama: 'Eko Prasetyo', kelas: '12 Bahasa',
                tagihan: [
                    { id: 't6', deskripsi: 'SPP Agustus 2025', jumlah: 525000 },
                    { id: 't7', deskripsi: 'Uang Buku LKS', jumlah: 250000 },
                ],
                pembayaran: []
            }
        ];

        let financeData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || getInitialData();

        const saveToLocalStorage = () => localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(financeData));

        // --- Fungsi Kalkulasi & Render ---
        const calculateTotals = (student) => {
            const totalTagihan = student.tagihan.reduce((sum, t) => sum + t.jumlah, 0);
            const totalTerbayar = student.pembayaran.reduce((sum, p) => sum + p.jumlah, 0);
            const sisaTunggakan = totalTagihan - totalTerbayar;
            return { totalTagihan, totalTerbayar, sisaTunggakan };
        };

        const renderDashboardCards = () => {
            let totalIncome = 0;
            let totalBills = 0;
            let paidOffCount = 0;
            financeData.forEach(student => {
                const { totalTagihan, totalTerbayar, sisaTunggakan } = calculateTotals(student);
                totalIncome += totalTerbayar;
                totalBills += totalTagihan;
                if (sisaTunggakan <= 0) paidOffCount++;
            });
            document.getElementById('totalIncome').textContent = formatRupiah(totalIncome);
            document.getElementById('totalOutstanding').textContent = formatRupiah(totalBills - totalIncome);
            document.getElementById('paidOffStudents').textContent = `${paidOffCount} / ${financeData.length}`;
        };

        const renderStudentSummaryTable = () => {
            studentFinanceTableBody.innerHTML = '';
            financeData.forEach(student => {
                const { totalTagihan, totalTerbayar, sisaTunggakan } = calculateTotals(student);
                const statusLunas = sisaTunggakan <= 0;
                const statusClass = statusLunas ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusText = statusLunas ? 'Lunas' : 'Belum Lunas';

                const row = `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">${student.nama}</td>
                        <td class="px-6 py-4">${student.kelas}</td>
                        <td class="px-6 py-4">${formatRupiah(totalTagihan)}</td>
                        <td class="px-6 py-4">${formatRupiah(totalTerbayar)}</td>
                        <td class="px-6 py-4 font-semibold ${sisaTunggakan > 0 ? 'text-red-600' : 'text-gray-800'}">${formatRupiah(sisaTunggakan)}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${statusText}</span></td>
                        <td class="px-6 py-4"><button onclick="openDetailModal('${student.id}')" class="font-medium text-blue-600 hover:underline">Lihat Detail</button></td>
                    </tr>
                `;
                studentFinanceTableBody.innerHTML += row;
            });
        };

        const renderPaymentHistory = (studentId) => {
            const student = financeData.find(s => s.id === studentId);
            const container = document.getElementById('paymentHistoryContainer');
            container.innerHTML = '';
            if (student.pembayaran.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Belum ada riwayat pembayaran.</p>';
                return;
            }
            // Urutkan pembayaran terbaru di atas
            const sortedPayments = [...student.pembayaran].sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));
            
            sortedPayments.forEach(p => {
                const paymentCard = `
                    <div class="border rounded-lg p-3 mb-3 bg-white">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-gray-800">${p.deskripsi}</p>
                                <p class="text-sm text-gray-500">${p.tanggal} • ${p.metode}</p>
                            </div>
                            <p class="font-semibold text-green-600 text-lg">${formatRupiah(p.jumlah)}</p>
                        </div>
                         <div class="flex justify-end items-center mt-2 space-x-3 text-xs">
                            <button onclick="handleEditPayment('${student.id}', '${p.id}')" class="font-medium text-blue-600 hover:underline">Edit</button>
                            <button onclick="handleDeletePayment('${student.id}', '${p.id}')" class="font-medium text-red-600 hover:underline">Hapus</button>
                        </div>
                    </div>
                `;
                container.innerHTML += paymentCard;
            });
        };
        
        // --- Fungsi Modal & Form ---
        window.openDetailModal = (studentId) => {
            const student = financeData.find(s => s.id === studentId);
            document.getElementById('modalTitle').textContent = `Detail Pembayaran`;
            document.getElementById('modalStudentInfo').textContent = `${student.nama} - ${student.kelas}`;
            document.getElementById('currentStudentId').value = studentId;
            newPaymentForm.reset();
            document.getElementById('paymentId').value = '';
            document.getElementById('paymentDate').valueAsDate = new Date();

            const paymentTypeSelect = document.getElementById('paymentType');
            paymentTypeSelect.innerHTML = '';
            student.tagihan.forEach(t => {
                const isPaid = student.pembayaran.some(p => p.deskripsi === t.deskripsi && p.jumlah >= t.jumlah);
                if (!isPaid) {
                    paymentTypeSelect.innerHTML += `<option value="${t.deskripsi}" data-amount="${t.jumlah}">${t.deskripsi}</option>`;
                }
            });
            // Auto-fill amount based on selection
            paymentTypeSelect.addEventListener('change', (e) => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                document.getElementById('paymentAmount').value = selectedOption.dataset.amount || '';
            });
            // Trigger change event for initial load
            if(paymentTypeSelect.options.length > 0) paymentTypeSelect.dispatchEvent(new Event('change'));

            renderPaymentHistory(studentId);
            modal.classList.remove('hidden');
        };

        const closeModal = () => modal.classList.add('hidden');

        newPaymentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const studentId = document.getElementById('currentStudentId').value;
            const paymentId = document.getElementById('paymentId').value;
            const student = financeData.find(s => s.id === studentId);

            const paymentData = {
                id: paymentId || Date.now().toString(),
                tanggal: document.getElementById('paymentDate').value,
                deskripsi: document.getElementById('paymentType').value,
                jumlah: parseInt(document.getElementById('paymentAmount').value),
                metode: document.getElementById('paymentMethod').value,
            };

            if (paymentId) { // Update mode
                const pIndex = student.pembayaran.findIndex(p => p.id === paymentId);
                student.pembayaran[pIndex] = paymentData;
            } else { // Create mode
                student.pembayaran.push(paymentData);
            }
            
            saveToLocalStorage();
            renderAll();
            renderPaymentHistory(studentId); // Re-render history inside modal
            newPaymentForm.reset();
             document.getElementById('paymentDate').valueAsDate = new Date();
        });
        
        // --- Handler Aksi (Edit/Delete) ---
        window.handleEditPayment = (studentId, paymentId) => {
            const student = financeData.find(s => s.id === studentId);
            const payment = student.pembayaran.find(p => p.id === paymentId);
            
            document.getElementById('paymentId').value = payment.id;
            document.getElementById('paymentType').value = payment.deskripsi;
            document.getElementById('paymentAmount').value = payment.jumlah;
            document.getElementById('paymentMethod').value = payment.metode;
            document.getElementById('paymentDate').value = payment.tanggal;
        };

        window.handleDeletePayment = (studentId, paymentId) => {
            if (!confirm('Apakah Anda yakin ingin menghapus catatan pembayaran ini?')) return;

            const student = financeData.find(s => s.id === studentId);
            student.pembayaran = student.pembayaran.filter(p => p.id !== paymentId);

            saveToLocalStorage();
            renderAll();
            renderPaymentHistory(studentId); // Re-render history in modal
        };

        // --- Inisialisasi ---
        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        
        const renderAll = () => {
            renderDashboardCards();
            renderStudentSummaryTable();
        };

        renderAll();
    });
    </script>
</body>
</html>