<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Guru - Aplikasi Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <style>
        .modal { transition: opacity 0.25s ease; }
        .sidebar-link.active { background-color: #3b82f6; color: white; font-weight: 600; }
        .toast { transition: opacity 0.3s ease, transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen">
        <div id="sidebar-placeholder"></div>
        
        <main class="flex-1 overflow-y-auto p-6 md:p-10">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div><h1 class="text-3xl font-bold text-gray-900">Manajemen Absensi Guru & Staf</h1><p class="text-gray-600 mt-1">Pantau kehadiran harian dan kelola pengajuan izin/cuti.</p></div>
                <div class="mt-4 md:mt-0"><label for="date-filter" class="text-sm font-medium text-gray-700">Tampilkan data untuk tanggal:</label><input type="date" id="date-filter" class="border rounded-lg p-2 mt-1 w-full md:w-auto"></div>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Total Staf</p><p id="statTotal" class="text-3xl font-bold text-gray-900">0</p></div>
                <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Hadir Hari Ini</p><p id="statHadir" class="text-3xl font-bold text-green-600">0</p></div>
                <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Tidak Hadir</p><p id="statTidakHadir" class="text-3xl font-bold text-red-600">0</p></div>
            </div>
            <div class="mt-8">
                <div class="border-b border-gray-200"><nav class="-mb-px flex space-x-8" aria-label="Tabs"><a href="#" id="tab-rekap" class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Rekap Harian</a><a href="#" id="tab-izin" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Pengajuan Izin/Cuti (<span id="izin-count">0</span>)</a></nav></div>
                <div id="content-rekap" class="mt-6 bg-white p-6 rounded-lg shadow-lg"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Nama Guru/Staf</th><th class="px-6 py-3">Jam Masuk</th><th class="px-6 py-3">Jam Pulang</th><th class="px-6 py-3">Durasi</th><th class="px-6 py-3">Status</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody id="rekapTableBody"></tbody></table></div></div>
                <div id="content-izin" class="mt-6 bg-white p-6 rounded-lg shadow-lg hidden"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Nama Guru/Staf</th><th class="px-6 py-3">Jenis Izin</th><th class="px-6 py-3">Tanggal</th><th class="px-6 py-3">Keterangan</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody id="izinTableBody"></tbody></table></div></div>
            </div>
        </main>
    </div>

    <!-- Modal for this page -->
    <div id="absensi_guru-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <form id="editForm" class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="text-xl font-bold mb-4">Edit Data Absensi</h3><p class="mb-4 text-gray-600" id="editModalInfo"></p><input type="hidden" id="editTeacherId"><input type="hidden" id="editDate"><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">Status Kehadiran</label><select id="editStatus" class="w-full border rounded py-2 px-3"></select></div><div id="jamContainer" class="grid grid-cols-2 gap-4 mb-6"><div><label class="block text-gray-700 text-sm font-bold mb-2">Jam Masuk</label><input type="time" id="editJamMasuk" class="w-full border rounded py-2 px-3"></div><div><label class="block text-gray-700 text-sm font-bold mb-2">Jam Pulang</label><input type="time" id="editJamPulang" class="w-full border rounded py-2 px-3"></div></div><div class="flex justify-end"><button type="button" class="cancel-modal-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mr-2">Batal</button><button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Simpan</button></div></form>
    </div>

    <div id="toast-container" class="fixed bottom-10 right-10 z-50"></div>

    <script src="assets/app.js"></script>
    <script src="assets/sidebar.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dateFilter = document.getElementById('date-filter');
            const rekapTableBody = document.getElementById('rekapTableBody');
            const izinTableBody = document.getElementById('izinTableBody');
            const modal = document.getElementById('absensi_guru-modal');
            const form = document.getElementById('editForm');
            
            const KEY_ATT = 'teacherAttendance', KEY_LEAVE = 'teacherLeaveRequests';
            const getInitialData = () => {
                const today = App.helpers.getToday();
                return {
                    att: [{ id: 'att1', teacherId: 'G01', tanggal: today, jamMasuk: '07:10', jamPulang: '15:25', status: 'Hadir'}, { id: 'att2', teacherId: 'G02', tanggal: today, jamMasuk: '07:15', jamPulang: '15:30', status: 'Hadir'}, { id: 'att3', teacherId: 'G03', tanggal: today, status: 'Sakit'}],
                    leave: [{ id: 'leave1', teacherId: 'G04', teacherName: 'Agus Wijayanto, S.S.', jenis: 'Izin Penting', tanggalMulai: '2025-08-25', tanggalSelesai: '2025-08-25', keterangan: 'Acara keluarga.', status: 'Pending' }]
                };
            };
            let attendanceData = JSON.parse(localStorage.getItem(KEY_ATT)) || getInitialData().att;
            let leaveRequests = JSON.parse(localStorage.getItem(KEY_LEAVE)) || getInitialData().leave;
            const saveAtt = () => localStorage.setItem(KEY_ATT, JSON.stringify(attendanceData));
            const saveLeave = () => localStorage.setItem(KEY_LEAVE, JSON.stringify(leaveRequests));

            const getStatusBadge = (status) => {
                const styles = { 'Hadir': 'bg-green-100 text-green-800', 'Sakit': 'bg-yellow-100 text-yellow-800', 'Izin': 'bg-blue-100 text-blue-800', 'Cuti': 'bg-purple-100 text-purple-800', 'Alpha': 'bg-red-100 text-red-800' };
                return `<span class="px-2 py-1 text-xs font-medium rounded-full ${styles[status] || ''}">${status}</span>`;
            };
            const calculateDuration = (start, end) => {
                if (!start || !end) return '-';
                const diff = (new Date(`1970-01-01T${end}:00`) - new Date(`1970-01-01T${start}:00`)) / 60000;
                if (diff < 0) return '-';
                return `${Math.floor(diff / 60)} jam ${diff % 60} mnt`;
            };
            const renderRecap = (date) => {
                rekapTableBody.innerHTML = '';
                let hadirCount = 0;
                App.masterData.guru.forEach(guru => {
                    let record = attendanceData.find(a => a.teacherId === guru.id && a.tanggal === date);
                    const onLeave = leaveRequests.find(l => l.teacherId === guru.id && l.status === 'Disetujui' && date >= l.tanggalMulai && date <= l.tanggalSelesai);
                    if (onLeave && !record) record = { status: onLeave.jenis };
                    const status = record ? record.status : 'Alpha';
                    if (status === 'Hadir') hadirCount++;
                    rekapTableBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${guru.nama}</td><td class="px-6 py-4">${record?.jamMasuk || '-'}</td><td class="px-6 py-4">${record?.jamPulang || '-'}</td><td class="px-6 py-4">${calculateDuration(record?.jamMasuk, record?.jamPulang)}</td><td class="px-6 py-4">${getStatusBadge(status)}</td><td class="px-6 py-4"><button class="edit-btn font-medium text-blue-600 hover:underline" data-teacher-id="${guru.id}" data-teacher-name="${guru.nama}" data-date="${date}">Edit</button></td></tr>`;
                });
                document.getElementById('statTotal').textContent = App.masterData.guru.length;
                document.getElementById('statHadir').textContent = hadirCount;
                document.getElementById('statTidakHadir').textContent = App.masterData.guru.length - hadirCount;
            };
            const renderLeave = () => {
                const pending = leaveRequests.filter(r => r.status === 'Pending');
                document.getElementById('izin-count').textContent = pending.length;
                izinTableBody.innerHTML = '';
                if (pending.length === 0) { izinTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-gray-500">Tidak ada pengajuan baru.</td></tr>`; return; }
                pending.forEach(req => {
                    izinTableBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${req.teacherName}</td><td class="px-6 py-4">${req.jenis}</td><td class="px-6 py-4">${req.tanggalMulai} s/d ${req.tanggalSelesai}</td><td class="px-6 py-4">${req.keterangan}</td><td class="px-6 py-4 flex space-x-2"><button class="action-btn bg-red-100 text-red-700 text-xs font-bold py-1 px-3 rounded-full hover:bg-red-200" data-id="${req.id}" data-action="Ditolak">Tolak</button><button class="action-btn bg-green-100 text-green-700 text-xs font-bold py-1 px-3 rounded-full hover:bg-green-200" data-id="${req.id}" data-action="Disetujui">Setujui</button></td></tr>`;
                });
            };
            
            const openModal = ({ teacherId, teacherName, date }) => {
                const record = attendanceData.find(a => a.teacherId === teacherId && a.tanggal === date) || {};
                document.getElementById('editModalInfo').textContent = `${teacherName} - ${date}`;
                document.getElementById('editTeacherId').value = teacherId;
                document.getElementById('editDate').value = date;
                const statusSelect = document.getElementById('editStatus');
                statusSelect.innerHTML = ['Hadir', 'Sakit', 'Izin', 'Cuti', 'Alpha'].map(s => `<option value="${s}" ${s === (record.status || 'Alpha') ? 'selected' : ''}>${s}</option>`).join('');
                document.getElementById('editJamMasuk').value = record.jamMasuk || '';
                document.getElementById('editJamPulang').value = record.jamPulang || '';
                const toggleJam = (status) => document.getElementById('jamContainer').style.display = status === 'Hadir' ? 'grid' : 'none';
                statusSelect.onchange = (e) => toggleJam(e.target.value);
                toggleJam(statusSelect.value);
                modal.classList.remove('hidden');
            };
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const teacherId = document.getElementById('editTeacherId').value;
                const date = document.getElementById('editDate').value;
                const status = document.getElementById('editStatus').value;
                let record = attendanceData.find(a => a.teacherId === teacherId && a.tanggal === date);
                if (!record) { record = { id: `att_${Date.now()}`, teacherId, tanggal: date }; attendanceData.push(record); }
                record.status = status;
                record.jamMasuk = document.getElementById('editJamMasuk').value;
                record.jamPulang = document.getElementById('editJamPulang').value;
                saveAtt(); renderRecap(dateFilter.value); modal.classList.add('hidden');
                App.helpers.showToast('Absensi guru berhasil diperbarui!');
            });

            rekapTableBody.addEventListener('click', (e) => { if (e.target.classList.contains('edit-btn')) openModal(e.target.dataset); });
            izinTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('action-btn')) {
                    const { id, action } = e.target.dataset;
                    if (!confirm(`Yakin ingin ${action === 'Disetujui' ? 'menyetujui' : 'menolak'} pengajuan ini?`)) return;
                    leaveRequests.find(r => r.id === id).status = action;
                    saveLeave(); renderLeave(); renderRecap(dateFilter.value);
                    App.helpers.showToast(`Pengajuan berhasil ${action.toLowerCase()}!`);
                }
            });

            dateFilter.value = App.helpers.getToday();
            dateFilter.addEventListener('change', () => renderRecap(dateFilter.value));
            const tabs = { rekap: document.getElementById('tab-rekap'), izin: document.getElementById('tab-izin') };
            const contents = { rekap: document.getElementById('content-rekap'), izin: document.getElementById('content-izin') };
            const switchTab = (active) => {
                Object.keys(tabs).forEach(key => {
                    const isActive = key === active;
                    tabs[key].className = isActive ? 'border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm';
                    contents[key].classList.toggle('hidden', !isActive);
                });
            };
            tabs.rekap.addEventListener('click', (e) => { e.preventDefault(); switchTab('rekap'); });
            tabs.izin.addEventListener('click', (e) => { e.preventDefault(); switchTab('izin'); });

            renderRecap(dateFilter.value);
            renderLeave();
        });
    </script>
</body>
</html>
