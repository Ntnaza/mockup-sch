<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengaturan Paket Keahlian</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        .sidebar-link.active { background-color: #3b82f6; color: white; font-weight: 600; }
        .toast { transition: opacity 0.3s ease, transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen">
        <div id="sidebar-placeholder"></div>
        
        <main class="flex-1 overflow-y-auto p-6 md:p-10">
            <header>
                <div class="text-sm breadcrumbs">
                    <ul>
                        <li><a href="#">Pengaturan Paket Keahlian</a></li>
                        <li>Daftar Pengaturan Paket Keahlian</li>
                    </ul>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <h1 class="text-3xl font-bold text-gray-900">Pengaturan Paket Keahlian</h1>
                    <div class="bg-green-500 text-white font-semibold py-2 px-4 rounded-full text-sm">
                        Tapel: <span id="tapel-display"></span> | Semester: <span id="semester-display"></span>
                    </div>
                </div>
            </header>
            
            <div class="mt-8 flex flex-col md:flex-row gap-6">
                
                <div class="w-full md:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Formulir</h3>
                    <form id="dataForm">
                        <input type="hidden" id="dataId">
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Tahun Pelajaran</label>
                            <p id="form-tapel" class="text-gray-800 font-medium"></p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Semester Aktif</label>
                            <p id="form-semester" class="text-gray-800 font-medium"></p>
                        </div>
                        
                        <div class="mb-4">
                            <label for="programKeahlian" class="block text-gray-700 text-sm font-bold mb-2">Nama Program Keahlian</label>
                            <select id="programKeahlian" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                                <option value="" disabled selected>- Pilih -</option>
                            </select>
                            <p id="program-keahlian-error" class="text-red-500 text-xs italic mt-1 hidden">Program Studi harus dipilih</p>
                        </div>
                        
                        <div class="mb-4">
                            <label for="paketKeahlian" class="block text-gray-700 text-sm font-bold mb-2">Nama Paket Keahlian</label>
                            <select id="paketKeahlian" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required disabled>
                                <option value="" disabled selected>- Pilih -</option>
                            </select>
                            <p id="paket-keahlian-error" class="text-red-500 text-xs italic mt-1 hidden">Program Keahlian harus dipilih</p>
                        </div>

                        <div class="mb-4">
                            <label for="kode" class="block text-gray-700 text-sm font-bold mb-2">Kode Paket Keahlian</label>
                            <input type="text" id="kode" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        </div>

                        <div class="mb-4">
                            <label for="alias" class="block text-gray-700 text-sm font-bold mb-2">Nama Paket Keahlian (Alias)</label>
                            <input type="text" id="alias" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        </div>

                        <div class="mb-4">
                            <label for="ketua" class="block text-gray-700 text-sm font-bold mb-2">Ketua Paket Keahlian</label>
                            <select id="ketua" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                                <option value="" disabled selected>- Pilih -</option>
                                <option value="Bpk. Budi">Bpk. Budi</option>
                                <option value="Ibu. Ani">Ibu. Ani</option>
                                <option value="Bpk. Joko">Bpk. Joko</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center justify-start pt-4 space-x-2">
                            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                                <ion-icon name="save-outline" class="mr-2"></ion-icon>Simpan
                            </button>
                            <button type="button" id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                                <ion-icon name="close-outline" class="mr-2"></ion-icon>Batal
                            </button>
                        </div>
                    </form>
                </div>

                <div class="w-full md:w-2/3 bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">Daftar Pengaturan Paket Keahlian</h3>
                    </div>
                    
                    <div class="p-4 bg-blue-100 border-l-4 border-blue-500 text-blue-700 mb-6">
                        <p class="font-bold">INFORMASI</p>
                        <p>Paket keahlian diatur setiap semester, jadi ketika anda memasuki semester aktif diharapkan untuk mengaturnya.</p>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">NO</th>
                                    <th scope="col" class="px-6 py-3">KODE</th>
                                    <th scope="col" class="px-6 py-3">PROGRAM KEAHLIAN</th>
                                    <th scope="col" class="px-6 py-3">PROGRAM STUDI</th>
                                    <th scope="col" class="px-6 py-3">KETUA</th>
                                    <th scope="col" class="px-6 py-3">AKSI</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast-container" class="fixed bottom-10 right-10 z-50"></div>
    
    <script src="../assets/app.js"></script>
    <script src="../assets/sidebar-sub.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('dataForm');
            const tableBody = document.getElementById('tableBody');
            const programKeahlianSelect = document.getElementById('programKeahlian');
            const paketKeahlianSelect = document.getElementById('paketKeahlian');
            const kodeInput = document.getElementById('kode');
            const aliasInput = document.getElementById('alias');
            const ketuaSelect = document.getElementById('ketua');
            const idInput = document.getElementById('dataId');
            const cancelBtn = document.getElementById('cancelBtn');

            // Data dummy
            const programStudiList = [
                { id: '1', name: 'TEKNOLOGI MANUFAKTUR DAN REKAYASA', kode: 'TMR' },
                { id: '2', name: 'MANAJEMEN PERKANTORAN', kode: 'MP' },
                { id: '3', name: 'SENI DAN EKONOMI KREATIF', kode: 'SEK' },
                { id: '4', name: 'TEKNOLOGI INFORMASI', kode: 'TI' },
                { id: '5', name: 'BISNIS MANAJEMEN', kode: 'BM' },
            ];

            const paketKeahlianList = {
                '1': [
                    { id: '1A', name: 'Teknik Otomotif', alias: 'TO', kode: 'TO' }
                ],
                '2': [
                    { id: '2A', name: 'Manajemen Perkantoran dan Layanan Bisnis', alias: 'MPLB', kode: 'MPLB' }
                ],
                '3': [
                    { id: '3A', name: 'Desain Komunikasi Visual', alias: 'DKV', kode: 'DKV' }
                ],
                '4': [
                    { id: '4A', name: 'Pengembangan Perangkat Lunak dan GIM', alias: 'PPLG', kode: 'PPLG' },
                    { id: '4B', name: 'Teknik Jaringan Komputer dan Telekomunikasi', alias: 'TJKT', kode: 'TJKT' }
                ],
                '5': [
                    { id: '5A', name: 'Akuntansi dan Keuangan Lembaga', alias: 'AKL', kode: 'AKL' }
                ]
            };
            
            // Mengambil tahun ajaran dan semester aktif dari local storage
            const activeYear = JSON.parse(localStorage.getItem('schoolAcademicYearsV2'))?.find(y => y.status === 'Aktif') || { tahun: '2025/2026' };
            const activeSemester = JSON.parse(localStorage.getItem('schoolSemesters'))?.find(s => s.status === 'Aktif') || { semester: 'Ganjil' };

            document.getElementById('tapel-display').textContent = activeYear.tahun;
            document.getElementById('semester-display').textContent = activeSemester.semester;
            document.getElementById('form-tapel').textContent = activeYear.tahun;
            document.getElementById('form-semester').textContent = activeSemester.semester;

            const KEY = `paket_keahlian_${activeYear.tahun.replace('/', '_')}_${activeSemester.semester}`;
            let paketKeahlianSettings = JSON.parse(localStorage.getItem(KEY)) || [];

            const save = () => localStorage.setItem(KEY, JSON.stringify(paketKeahlianSettings));

            const populateProgramKeahlian = () => {
                programStudiList.forEach(prodi => {
                    const option = document.createElement('option');
                    option.value = prodi.id;
                    option.textContent = prodi.name;
                    programKeahlianSelect.appendChild(option);
                });
            };

            const populatePaketKeahlian = (prodiId) => {
                paketKeahlianSelect.innerHTML = '<option value="" disabled selected>- Pilih -</option>';
                paketKeahlianSelect.disabled = false;
                const paketList = paketKeahlianList[prodiId] || [];
                paketList.forEach(paket => {
                    const option = document.createElement('option');
                    option.value = paket.id;
                    option.textContent = paket.name;
                    paketKeahlianSelect.appendChild(option);
                });
            };

            const render = () => {
                tableBody.innerHTML = '';
                if (paketKeahlianSettings.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4">Belum ada data.</td></tr>`;
                    return;
                }
                
                paketKeahlianSettings.forEach((item, index) => {
                    tableBody.innerHTML += `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4">${item.kode}</td>
                            <td class="px-6 py-4">${item.programKeahlian}</td>
                            <td class="px-6 py-4">${item.paketKeahlian}</td>
                            <td class="px-6 py-4">${item.ketua}</td>
                            <td class="px-6 py-4 flex space-x-3 text-lg">
                                <button class="edit-btn text-blue-500 hover:text-blue-700" data-id="${item.id}" title="Edit"><ion-icon name="create-outline"></ion-icon></button>
                                <button class="delete-btn text-red-500 hover:text-red-700" data-id="${item.id}" title="Hapus"><ion-icon name="trash-outline"></ion-icon></button>
                            </td>
                        </tr>`;
                });
            };

            const resetForm = () => {
                form.reset();
                idInput.value = '';
                kodeInput.value = '';
                aliasInput.value = '';
                programKeahlianSelect.value = '';
                paketKeahlianSelect.innerHTML = '<option value="" disabled selected>- Pilih -</option>';
                paketKeahlianSelect.disabled = true;
            };
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const selectedProdi = programStudiList.find(p => p.id === programKeahlianSelect.value);
                const selectedPaket = paketKeahlianList[programKeahlianSelect.value]?.find(pk => pk.id === paketKeahlianSelect.value);
                
                const formData = {
                    id: idInput.value || Date.now().toString(),
                    kode: kodeInput.value,
                    programKeahlian: selectedProdi.name,
                    paketKeahlian: selectedPaket.name,
                    ketua: ketuaSelect.value,
                };
                
                if (idInput.value) {
                    const index = paketKeahlianSettings.findIndex(p => p.id === formData.id);
                    paketKeahlianSettings[index] = formData;
                } else {
                    paketKeahlianSettings.push(formData);
                }
                save(); 
                render(); 
                resetForm();
                App.helpers.showToast('Data berhasil disimpan!');
            });

            programKeahlianSelect.addEventListener('change', (e) => {
                const prodiId = e.target.value;
                populatePaketKeahlian(prodiId);
            });

            tableBody.addEventListener('click', (e) => {
                const id = e.target.closest('button')?.dataset.id;
                if (!id) return;

                if (e.target.closest('.edit-btn')) {
                    const item = paketKeahlianSettings.find(item => item.id === id);
                    if (item) {
                        idInput.value = item.id;
                        // Logika edit untuk dropdown bisa lebih kompleks,
                        // Anda mungkin perlu menyimpan ID program keahlian dan paket keahlian
                        // saat data disimpan untuk mengisi kembali dropdown dengan benar.
                        kodeInput.value = item.kode;
                        aliasInput.value = item.paketKeahlian; // Menggunakan paketKeahlian sebagai alias
                        ketuaSelect.value = item.ketua;
                        App.helpers.showToast('Data berhasil di-edit!');
                    }
                }
                
                if (e.target.closest('.delete-btn')) {
                    if (confirm('Yakin ingin hapus data ini?')) {
                        paketKeahlianSettings = paketKeahlianSettings.filter(p => p.id !== id);
                        save(); 
                        render();
                        App.helpers.showToast('Data berhasil dihapus!', 'error');
                    }
                }
            });

            cancelBtn.addEventListener('click', resetForm);
            
            // Inisialisasi
            populateProgramKeahlian();
            render();
        });
    </script>
</body>
</html>