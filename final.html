<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Sekolah Terpadu - Versi Final</title>
    <!-- Menggunakan Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Menambahkan ikon dari Ionicons -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        /* CSS untuk navigasi, modal, dan notifikasi */
        .modal { transition: opacity 0.25s ease; }
        .content-page { display: none; }
        .content-page.active { display: block; }
        .sidebar-link.active { background-color: #3b82f6; color: white; font-weight: 600; }
        .custom-radio:checked + label { border-color: #3b82f6; background-color: #eff6ff; color: #2563eb; }
        .toast { transition: opacity 0.3s ease, transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen">
        <!-- Sidebar Navigasi Utama -->
        <aside class="w-64 bg-white shadow-md hidden md:block flex-shrink-0">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800">App Sekolah</h2>
                <p class="text-sm text-gray-500">Versi Terpadu</p>
            </div>
            <nav id="main-nav" class="mt-6">
                <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200" data-page="dashboard"><ion-icon name="grid-outline" class="w-5 h-5"></ion-icon><span class="mx-4">Dashboard</span></a>
                <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200" data-page="ppdb"><ion-icon name="people-outline" class="w-5 h-5"></ion-icon><span class="mx-4">PPDB</span></a>
                <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200" data-page="keuangan"><ion-icon name="wallet-outline" class="w-5 h-5"></ion-icon><span class="mx-4">Keuangan</span></a>
                <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200" data-page="akademik"><ion-icon name="book-outline" class="w-5 h-5"></ion-icon><span class="mx-4">Akademik</span></a>
                <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200" data-page="absensi_siswa"><ion-icon name="checkmark-done-outline" class="w-5 h-5"></ion-icon><span class="mx-4">Absensi Siswa</span></a>
                <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200" data-page="pelanggaran"><ion-icon name="alert-circle-outline" class="w-5 h-5"></ion-icon><span class="mx-4">Pelanggaran</span></a>
                <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200" data-page="absensi_guru"><ion-icon name="finger-print-outline" class="w-5 h-5"></ion-icon><span class="mx-4">Absensi Guru</span></a>
                <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200" data-page="buku_tamu"><ion-icon name="id-card-outline" class="w-5 h-5"></ion-icon><span class="mx-4">Buku Tamu</span></a>
            </nav>
        </aside>
        
        <!-- Kontainer Utama untuk Semua Halaman Modul -->
        <main class="flex-1 overflow-y-auto">
            <div id="content-dashboard" class="content-page p-6 md:p-10"></div>
            <div id="content-ppdb" class="content-page p-6 md:p-10"></div>
            <div id="content-keuangan" class="content-page p-6 md:p-10"></div>
            <div id="content-akademik" class="content-page p-6 md:p-10"></div>
            <div id="content-absensi_siswa" class="content-page p-6 md:p-10"></div>
            <div id="content-pelanggaran" class="content-page p-6 md:p-10"></div>
            <div id="content-absensi_guru" class="content-page p-6 md:p-10"></div>
            <div id="content-buku_tamu" class="content-page p-6 md:p-10"></div>
        </main>
    </div>

    <!-- Kontainer untuk Semua Modal Pop-up -->
    <div id="ppdb-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"></div>
    <div id="keuangan-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"></div>
    <div id="absensi_siswa-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"></div>
    <div id="pelanggaran-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"></div>
    <div id="absensi_guru-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"></div>
    <div id="buku_tamu-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"></div>

    <!-- Kontainer untuk Notifikasi Toast -->
    <div id="toast-container" class="fixed bottom-10 right-10 z-50"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // =================================================================
    // APLIKASI UTAMA (OBJECT APP)
    // =================================================================
    const App = {
        // =================================================================
        // DATA MASTER & HELPER
        // =================================================================
        helpers: {
            formatRupiah: (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number),
            showToast: (message, type = 'success') => {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                toast.className = `${bgColor} text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 toast`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.classList.remove('opacity-0', 'translate-y-2');
                    toast.classList.add('opacity-100', 'translate-y-0');
                }, 10);
                setTimeout(() => {
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },
            getToday: () => new Date().toISOString().slice(0, 10),
        },
        
        masterData: {
            siswa: {
                "10 IPA 1": ["Ahmad Fauzi", "Budi Santoso", "Citra Lestari", "Dewi Anggraini", "Eko Prasetyo"],
                "11 IPS 2": ["Fajar Nugraha", "Gita Permata", "Hadi Wijaya", "Indah Sari", "Joko Susilo"],
                "12 Bahasa": ["Kartika Putri", "Lia Amelia", "Mega Utami", "Nina Rosdiana", "Putra Bangsa"]
            },
            guru: [
                { id: 'G01', nama: 'Dr. Indah Permata, M.Pd.', nip: '1975...' },
                { id: 'G02', nama: 'Bambang Subagio, S.Kom.', nip: '1980...' },
                { id: 'G03', nama: 'Siti Nurhaliza, S.Pd.', nip: '1985...' },
                { id: 'G04', nama: 'Agus Wijayanto, S.S.', nip: '1990...' },
            ],
            mapel: ["Matematika", "Fisika", "Bahasa Indonesia", "Sejarah"],
        },

        // =================================================================
        // TEMPLATES HTML
        // =================================================================
        templates: {
            injectAll: function() {
                const contentTemplates = this.getContentTemplates();
                const modalTemplates = this.getModalTemplates();
                for (const [key, value] of Object.entries(contentTemplates)) {
                    document.getElementById(`content-${key}`).innerHTML = value;
                }
                for (const [key, value] of Object.entries(modalTemplates)) {
                    document.getElementById(`${key}-modal`).innerHTML = value;
                }
            },
            getContentTemplates: function() {
                return {
                    dashboard: `
                        <header><h1 class="text-3xl font-bold text-gray-900">Dashboard Utama</h1><p class="text-gray-600 mt-1">Selamat datang di Sistem Informasi Sekolah Terpadu.</p></header>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                            <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Total Pendaftar PPDB</p><p id="dashboard_stat_ppdb" class="text-3xl font-bold text-gray-900">0</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Total Tunggakan Keuangan</p><p id="dashboard_stat_keuangan" class="text-3xl font-bold text-red-600">Rp 0</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Pengajuan Izin Guru (Pending)</p><p id="dashboard_stat_izin" class="text-3xl font-bold text-yellow-600">0</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Tamu Masih di Lokasi</p><p id="dashboard_stat_tamu" class="text-3xl font-bold text-blue-600">0</p></div>
                        </div>
                        <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Akses Cepat</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <button class="quick-link text-left p-4 bg-gray-50 hover:bg-gray-100 rounded-lg" data-page="ppdb"><ion-icon name="people-outline" class="text-2xl text-blue-500"></ion-icon><p class="font-semibold mt-2">Lihat Pendaftar PPDB</p></button>
                                <button class="quick-link text-left p-4 bg-gray-50 hover:bg-gray-100 rounded-lg" data-page="keuangan"><ion-icon name="wallet-outline" class="text-2xl text-green-500"></ion-icon><p class="font-semibold mt-2">Cek Keuangan Siswa</p></button>
                                <button class="quick-link text-left p-4 bg-gray-50 hover:bg-gray-100 rounded-lg" data-page="absensi_siswa"><ion-icon name="checkmark-done-outline" class="text-2xl text-yellow-500"></ion-icon><p class="font-semibold mt-2">Input Absensi Siswa</p></button>
                                <button class="quick-link text-left p-4 bg-gray-50 hover:bg-gray-100 rounded-lg" data-page="akademik"><ion-icon name="book-outline" class="text-2xl text-purple-500"></ion-icon><p class="font-semibold mt-2">Kelola Nilai</p></button>
                            </div>
                        </div>`,
                    ppdb: `
                        <header><h1 class="text-3xl font-bold text-gray-900">Manajemen PPDB</h1><p class="text-gray-600 mt-1">Kelola dan pantau semua calon siswa yang mendaftar.</p></header>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-8">
                            <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Total Pendaftar</p><p id="ppdb_statTotal" class="text-3xl font-bold text-gray-900">0</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Lolos Verifikasi</p><p id="ppdb_statVerified" class="text-3xl font-bold text-blue-600">0</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Diterima</p><p id="ppdb_statAccepted" class="text-3xl font-bold text-green-600">0</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Ditolak</p><p id="ppdb_statRejected" class="text-3xl font-bold text-red-600">0</p></div>
                        </div>
                        <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
                            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                                <h3 class="text-xl font-semibold text-gray-800">Daftar Pendaftar</h3>
                                <div class="flex items-center gap-4 w-full md:w-auto">
                                    <select id="ppdb_filterStatus" class="border rounded py-2 px-3 text-sm"><option value="">Semua Status</option><option value="Menunggu Verifikasi">Menunggu Verifikasi</option><option value="Lolos Verifikasi">Lolos Verifikasi</option><option value="Diterima">Diterima</option><option value="Ditolak">Ditolak</option></select>
                                    <button id="ppdb_addApplicantBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Tambah</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">No. Pendaftaran</th><th class="px-6 py-3">Nama Calon Siswa</th><th class="px-6 py-3">Asal Sekolah</th><th class="px-6 py-3">Jalur</th><th class="px-6 py-3">Status</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody id="ppdb_applicantTableBody"></tbody></table></div>
                        </div>`,
                    keuangan: `
                        <header><h1 class="text-3xl font-bold text-gray-900">Manajemen Keuangan Sekolah</h1><p class="text-gray-600 mt-1">Pantau status pembayaran, catat transaksi, dan lihat rekapitulasi keuangan.</p></header>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                            <div class="bg-white p-6 rounded-lg shadow-lg flex items-center"><div class="bg-green-100 p-3 rounded-full"><ion-icon name="cash-outline" class="text-3xl text-green-600"></ion-icon></div><div class="ml-4"><p class="text-gray-500">Total Pemasukan</p><p id="keuangan_totalIncome" class="text-2xl font-bold text-gray-900">Rp 0</p></div></div>
                            <div class="bg-white p-6 rounded-lg shadow-lg flex items-center"><div class="bg-red-100 p-3 rounded-full"><ion-icon name="document-text-outline" class="text-3xl text-red-600"></ion-icon></div><div class="ml-4"><p class="text-gray-500">Total Tunggakan</p><p id="keuangan_totalOutstanding" class="text-2xl font-bold text-gray-900">Rp 0</p></div></div>
                            <div class="bg-white p-6 rounded-lg shadow-lg flex items-center"><div class="bg-blue-100 p-3 rounded-full"><ion-icon name="checkmark-circle-outline" class="text-3xl text-blue-600"></ion-icon></div><div class="ml-4"><p class="text-gray-500">Siswa Lunas</p><p id="keuangan_paidOffStudents" class="text-2xl font-bold text-gray-900">0 / 0</p></div></div>
                        </div>
                        <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-6">Status Pembayaran Siswa</h3>
                            <div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="px-6 py-3">Nama Siswa</th><th scope="col" class="px-6 py-3">Kelas</th><th scope="col" class="px-6 py-3">Total Tagihan</th><th scope="col" class="px-6 py-3">Total Terbayar</th><th scope="col" class="px-6 py-3">Sisa Tunggakan</th><th scope="col" class="px-6 py-3">Status</th><th scope="col" class="px-6 py-3">Aksi</th></tr></thead><tbody id="keuangan_studentFinanceTableBody"></tbody></table></div>
                        </div>`,
                    akademik: `
                        <header><h1 class="text-3xl font-bold text-gray-900">Manajemen Nilai Akademik</h1><p class="text-gray-600 mt-1">Input dan kelola nilai siswa per mata pelajaran dengan mudah.</p></header>
                        <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
                            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                                <h3 class="text-xl font-semibold text-gray-800">Daftar Nilai Siswa</h3>
                                <div class="flex items-center gap-4 w-full md:w-auto"><select id="akademik_classSelect" class="border rounded py-2 px-3 text-sm w-full"></select><select id="akademik_subjectSelect" class="border rounded py-2 px-3 text-sm w-full"></select></div>
                            </div>
                            <div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3 w-1/4">Nama Siswa</th><th class="px-3 py-3 text-center">Tugas (20%)</th><th class="px-3 py-3 text-center">Harian (20%)</th><th class="px-3 py-3 text-center">UTS (30%)</th><th class="px-3 py-3 text-center">UAS (30%)</th><th class="px-6 py-3 text-center">Nilai Akhir</th></tr></thead><tbody id="akademik_gradeTableBody"></tbody></table></div>
                            <div class="flex justify-end mt-6"><button id="akademik_saveGradesBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg flex items-center"><ion-icon name="save-outline" class="mr-2"></ion-icon>Simpan Semua Perubahan</button></div>
                        </div>`,
                    absensi_siswa: `
                        <header><h1 class="text-3xl font-bold text-gray-900">Manajemen Absensi Siswa</h1><p class="text-gray-600 mt-1">Buat, lihat, dan kelola rekap absensi harian per kelas.</p></header>
                        <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-semibold text-gray-800">Riwayat Absensi</h3><button id="absensiSiswa_addAttendanceBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center"><ion-icon name="add-outline" class="mr-2"></ion-icon>Buat Absensi Baru</button></div>
                            <div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="px-6 py-3">Tanggal</th><th scope="col" class="px-6 py-3">Kelas</th><th scope="col" class="px-6 py-3 text-center text-green-600">Hadir</th><th scope="col" class="px-6 py-3 text-center text-yellow-600">Sakit</th><th scope="col" class="px-6 py-3 text-center text-blue-600">Izin</th><th scope="col" class="px-6 py-3 text-center text-red-600">Alpha</th><th scope="col" class="px-6 py-3">Aksi</th></tr></thead><tbody id="absensiSiswa_attendanceHistoryTableBody"></tbody></table></div>
                        </div>`,
                    pelanggaran: `
                        <header><h1 class="text-3xl font-bold text-gray-900">Manajemen Pelanggaran Siswa</h1><p class="text-gray-600 mt-1">Catat, lihat, dan kelola semua data pelanggaran siswa secara terpusat.</p></header>
                        <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-semibold text-gray-800">Daftar Pelanggaran</h3><button id="pelanggaran_addViolationBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center"><ion-icon name="add-outline" class="mr-2"></ion-icon>Tambah Data</button></div>
                            <div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="px-6 py-3">Nama Siswa</th><th scope="col" class="px-6 py-3">Kelas</th><th scope="col" class="px-6 py-3">Jenis Pelanggaran</th><th scope="col" class="px-6 py-3">Poin</th><th scope="col" class="px-6 py-3">Tanggal</th><th scope="col" class="px-6 py-3">Aksi</th></tr></thead><tbody id="pelanggaran_violationTableBody"></tbody></table></div>
                        </div>`,
                    absensi_guru: `
                        <header class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div><h1 class="text-3xl font-bold text-gray-900">Manajemen Absensi Guru & Staf</h1><p class="text-gray-600 mt-1">Pantau kehadiran harian dan kelola pengajuan izin/cuti.</p></div>
                            <div class="mt-4 md:mt-0"><label for="absensiGuru_date-filter" class="text-sm font-medium text-gray-700">Tampilkan data untuk tanggal:</label><input type="date" id="absensiGuru_date-filter" class="border rounded-lg p-2 mt-1 w-full md:w-auto"></div>
                        </header>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                            <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Total Staf</p><p id="absensiGuru_statTotal" class="text-3xl font-bold text-gray-900">0</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Hadir Hari Ini</p><p id="absensiGuru_statHadir" class="text-3xl font-bold text-green-600">0</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Tidak Hadir</p><p id="absensiGuru_statTidakHadir" class="text-3xl font-bold text-red-600">0</p></div>
                        </div>
                        <div class="mt-8">
                            <div class="border-b border-gray-200"><nav class="-mb-px flex space-x-8" aria-label="Tabs"><a href="#" id="absensiGuru_tab-rekap" class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Rekap Harian</a><a href="#" id="absensiGuru_tab-izin" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Pengajuan Izin/Cuti (<span id="absensiGuru_izin-count">0</span>)</a></nav></div>
                            <div id="absensiGuru_content-rekap" class="mt-6 bg-white p-6 rounded-lg shadow-lg"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Nama Guru/Staf</th><th class="px-6 py-3">Jam Masuk</th><th class="px-6 py-3">Jam Pulang</th><th class="px-6 py-3">Durasi</th><th class="px-6 py-3">Status</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody id="absensiGuru_rekapTableBody"></tbody></table></div></div>
                            <div id="absensiGuru_content-izin" class="mt-6 bg-white p-6 rounded-lg shadow-lg hidden"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Nama Guru/Staf</th><th class="px-6 py-3">Jenis Izin</th><th class="px-6 py-3">Tanggal</th><th class="px-6 py-3">Keterangan</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody id="absensiGuru_izinTableBody"></tbody></table></div></div>
                        </div>`,
                    buku_tamu: `
                        <header class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div><h1 class="text-3xl font-bold text-gray-900">Buku Tamu Digital</h1><p class="text-gray-600 mt-1">Catat dan kelola semua tamu yang berkunjung ke sekolah.</p></div>
                            <div class="mt-4 md:mt-0"><label for="bukuTamu_date-filter" class="text-sm font-medium text-gray-700">Riwayat tanggal:</label><input type="date" id="bukuTamu_date-filter" class="border rounded-lg p-2 mt-1 w-full md:w-auto"></div>
                        </header>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                            <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Total Kunjungan Hari Ini</p><p id="bukuTamu_statTotal" class="text-3xl font-bold text-gray-900">0</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Tamu Masih di Lokasi</p><p id="bukuTamu_statCurrent" class="text-3xl font-bold text-blue-600">0</p></div>
                        </div>
                        <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-semibold text-gray-800">Daftar Tamu</h3><button id="bukuTamu_addGuestBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center"><ion-icon name="add-outline" class="mr-2"></ion-icon> Tambah Tamu</button></div>
                            <div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Waktu Masuk</th><th class="px-6 py-3">Nama Tamu</th><th class="px-6 py-3">Bertemu Dengan</th><th class="px-6 py-3">Tujuan</th><th class="px-6 py-3">Waktu Keluar</th><th class="px-6 py-3">Status</th><th class="px-6 py-3 text-center">Aksi</th></tr></thead><tbody id="bukuTamu_guestTableBody"></tbody></table></div>
                        </div>`,
                };
            },
            getModalTemplates: function() {
                return {
                    ppdb: `<div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col"><div class="p-6 border-b flex justify-between items-center"><h3 id="ppdb_modalTitle" class="text-2xl font-bold">Detail Calon Siswa</h3><button class="close-modal-btn text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div class="p-6 overflow-y-auto flex-grow space-y-6"><div><h4 class="font-bold text-lg mb-2 text-gray-800 border-b pb-2">Data Diri</h4><div id="ppdb_dataDiri" class="grid grid-cols-2 gap-4 text-sm text-gray-700"></div></div><div><h4 class="font-bold text-lg mb-2 text-gray-800 border-b pb-2">Data Orang Tua</h4><div id="ppdb_dataOrangTua" class="grid grid-cols-2 gap-4 text-sm text-gray-700"></div></div><div><h4 class="font-bold text-lg mb-2 text-gray-800 border-b pb-2">Berkas Pendukung</h4><ul id="ppdb_berkasList" class="space-y-2 text-sm"></ul></div></div><div id="ppdb_modalActionFooter" class="p-4 border-t bg-gray-50 flex items-center justify-end space-x-3"></div></div>`,
                    keuangan: `<div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col"><div class="p-6 border-b flex justify-between items-center"><div><h3 id="keuangan_modalTitle" class="text-2xl font-bold">Detail Pembayaran</h3><p id="keuangan_modalStudentInfo" class="text-gray-600"></p></div><button class="close-modal-btn text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div class="p-6 overflow-y-auto flex-grow grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-2"><h4 class="font-bold text-lg mb-4">Riwayat Pembayaran</h4><div id="keuangan_paymentHistoryContainer" class="overflow-auto" style="max-height: 400px;"></div></div><div class="bg-gray-50 p-4 rounded-lg"><h4 class="font-bold text-lg mb-4">Catat Pembayaran Baru</h4><form id="keuangan_newPaymentForm"><input type="hidden" id="keuangan_currentStudentId"><input type="hidden" id="keuangan_paymentId"><div class="mb-4"><label for="keuangan_paymentType" class="block text-gray-700 text-sm font-bold mb-2">Jenis Pembayaran:</label><select id="keuangan_paymentType" class="shadow border rounded w-full py-2 px-3" required></select></div><div class="mb-4"><label for="keuangan_paymentAmount" class="block text-gray-700 text-sm font-bold mb-2">Jumlah Bayar (Rp):</label><input type="number" id="keuangan_paymentAmount" class="shadow border rounded w-full py-2 px-3" required></div><div class="mb-4"><label for="keuangan_paymentMethod" class="block text-gray-700 text-sm font-bold mb-2">Metode Bayar:</label><select id="keuangan_paymentMethod" class="shadow border rounded w-full py-2 px-3" required><option>Transfer Bank</option><option>Cash</option><option>QRIS</option></select></div><div class="mb-4"><label for="keuangan_paymentDate" class="block text-gray-700 text-sm font-bold mb-2">Tanggal Bayar:</label><input type="date" id="keuangan_paymentDate" class="shadow border rounded w-full py-2 px-3" required></div><button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Simpan Pembayaran</button></form></div></div></div>`,
                    absensi_siswa: `<div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col"><div class="p-6 border-b"><h3 id="absensiSiswa_modalTitle" class="text-2xl font-bold">Buat Absensi Kelas</h3><form id="absensiSiswa_attendanceSetupForm" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="absensiSiswa_classSelect" class="block text-gray-700 text-sm font-bold mb-2">Pilih Kelas:</label><select id="absensiSiswa_classSelect" class="shadow border rounded w-full py-2 px-3 text-gray-700" required></select></div><div><label for="absensiSiswa_attendanceDate" class="block text-gray-700 text-sm font-bold mb-2">Tanggal:</label><input type="date" id="absensiSiswa_attendanceDate" class="shadow border rounded w-full py-2 px-3 text-gray-700" required></div></form></div><div id="absensiSiswa_studentListContainer" class="p-6 overflow-y-auto"><p class="text-center text-gray-500">Pilih kelas dan tanggal untuk menampilkan daftar siswa.</p></div><div class="p-6 border-t bg-gray-50 flex items-center justify-end rounded-b-lg"><button type="button" class="cancel-modal-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mr-2">Batal</button><button type="button" id="absensiSiswa_saveAttendanceBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Simpan Absensi</button></div></div>`,
                    pelanggaran: `<div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 id="pelanggaran_modalTitle" class="text-2xl font-bold mb-4">Tambah Pelanggaran Baru</h3><form id="pelanggaran_violationForm"><input type="hidden" id="pelanggaran_violationId"><div class="mb-4"><label for="pelanggaran_studentName" class="block text-gray-700 text-sm font-bold mb-2">Nama Siswa:</label><input type="text" id="pelanggaran_studentName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required></div><div class="mb-4"><label for="pelanggaran_studentClass" class="block text-gray-700 text-sm font-bold mb-2">Kelas:</label><input type="text" id="pelanggaran_studentClass" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required></div><div class="mb-4"><label for="pelanggaran_violationType" class="block text-gray-700 text-sm font-bold mb-2">Jenis Pelanggaran:</label><input type="text" id="pelanggaran_violationType" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required></div><div class="grid grid-cols-2 gap-4 mb-6"><div><label for="pelanggaran_points" class="block text-gray-700 text-sm font-bold mb-2">Poin:</label><input type="number" id="pelanggaran_points" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required></div><div><label for="pelanggaran_date" class="block text-gray-700 text-sm font-bold mb-2">Tanggal:</label><input type="date" id="pelanggaran_date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required></div></div><div class="flex items-center justify-end"><button type="button" class="cancel-modal-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mr-2">Batal</button><button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Simpan</button></div></form></div>`,
                    absensi_guru: `<form id="absensiGuru_editForm" class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="text-xl font-bold mb-4">Edit Data Absensi</h3><p class="mb-4 text-gray-600" id="absensiGuru_editModalInfo"></p><input type="hidden" id="absensiGuru_editTeacherId"><input type="hidden" id="absensiGuru_editDate"><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">Status Kehadiran</label><select id="absensiGuru_editStatus" class="w-full border rounded py-2 px-3"></select></div><div id="absensiGuru_jamContainer" class="grid grid-cols-2 gap-4 mb-6"><div><label class="block text-gray-700 text-sm font-bold mb-2">Jam Masuk</label><input type="time" id="absensiGuru_editJamMasuk" class="w-full border rounded py-2 px-3"></div><div><label class="block text-gray-700 text-sm font-bold mb-2">Jam Pulang</label><input type="time" id="absensiGuru_editJamPulang" class="w-full border rounded py-2 px-3"></div></div><div class="flex justify-end"><button type="button" class="cancel-modal-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mr-2">Batal</button><button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Simpan</button></div></form>`,
                    buku_tamu: `<form id="bukuTamu_addGuestForm" class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 space-y-4"><h3 class="text-xl font-bold mb-4">Formulir Tamu Baru</h3><div><label class="block text-gray-700 text-sm font-bold mb-2">Nama Tamu</label><input type="text" id="bukuTamu_guestName" class="w-full border rounded py-2 px-3" required></div><div><label class="block text-gray-700 text-sm font-bold mb-2">Asal/Instansi</label><input type="text" id="bukuTamu_guestOrigin" class="w-full border rounded py-2 px-3" required></div><div><label class="block text-gray-700 text-sm font-bold mb-2">Bertemu Dengan (Nama Guru/Staf)</label><input type="text" id="bukuTamu_guestMeeting" class="w-full border rounded py-2 px-3" required></div><div><label class="block text-gray-700 text-sm font-bold mb-2">Tujuan Kunjungan</label><textarea id="bukuTamu_guestPurpose" class="w-full border rounded py-2 px-3" rows="3" required></textarea></div><div class="flex justify-end pt-4"><button type="button" class="cancel-modal-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mr-2">Batal</button><button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Simpan & Check-in</button></div></form>`,
                };
            },
        },

        // =================================================================
        // NAVIGASI
        // =================================================================
        navigation: {
            init: function() {
                const mainNav = document.getElementById('main-nav');
                mainNav.addEventListener('click', (e) => {
                    const link = e.target.closest('.sidebar-link');
                    if (link) { e.preventDefault(); this.navigateTo(link.dataset.page); }
                });
                
                document.getElementById('content-dashboard').addEventListener('click', (e) => {
                    const link = e.target.closest('.quick-link');
                    if (link) { e.preventDefault(); this.navigateTo(link.dataset.page); }
                });
            },
            navigateTo: function(pageId) {
                document.querySelectorAll('.content-page').forEach(page => page.classList.remove('active'));
                document.getElementById(`content-${pageId}`).classList.add('active');
                document.querySelectorAll('.sidebar-link').forEach(link => {
                    link.classList.toggle('active', link.dataset.page === pageId);
                });
                if(pageId === 'dashboard') App.dashboard.init();
            }
        },

        // =================================================================
        // MODUL-MODUL (DEFINISI LENGKAP)
        // =================================================================
        dashboard: {
            init: function() {
                const ppdbData = JSON.parse(localStorage.getItem('ppdbApplicants')) || [];
                const financeData = JSON.parse(localStorage.getItem('schoolFinanceData')) || [];
                const leaveRequests = JSON.parse(localStorage.getItem('teacherLeaveRequests')) || [];
                const guestLog = JSON.parse(localStorage.getItem('schoolGuestLog')) || [];
                
                document.getElementById('dashboard_stat_ppdb').textContent = ppdbData.length;
                
                let totalOutstanding = 0;
                if(financeData.length > 0) {
                    financeData.forEach(student => {
                        const totalTagihan = student.tagihan.reduce((sum, t) => sum + t.jumlah, 0);
                        const totalTerbayar = student.pembayaran.reduce((sum, p) => sum + p.jumlah, 0);
                        totalOutstanding += (totalTagihan - totalTerbayar);
                    });
                }
                document.getElementById('dashboard_stat_keuangan').textContent = App.helpers.formatRupiah(totalOutstanding);
                document.getElementById('dashboard_stat_izin').textContent = leaveRequests.filter(r => r.status === 'Pending').length;
                document.getElementById('dashboard_stat_tamu').textContent = guestLog.filter(g => g.tanggal === App.helpers.getToday() && g.status === 'Masih di Lokasi').length;
            }
        },
        
        pelanggaran: {
            init: function() {
                const addBtn = document.getElementById('pelanggaran_addViolationBtn');
                const modal = document.getElementById('pelanggaran-modal');
                const form = document.getElementById('pelanggaran_violationForm');
                const tableBody = document.getElementById('pelanggaran_violationTableBody');
                const modalTitle = document.getElementById('pelanggaran_modalTitle');
                const idInput = document.getElementById('pelanggaran_violationId');
                
                const KEY = 'schoolViolations';
                const getInitialData = () => [{id: '1', name: 'Budi Santoso', class: '10 IPA 1', type: 'Terlambat', points: '5', date: '2025-08-20'}, {id: '2', name: 'Ani Lestari', class: '11 IPS 2', type: 'Seragam tidak lengkap', points: '10', date: '2025-08-22'}];
                let violations = JSON.parse(localStorage.getItem(KEY)) || getInitialData();
                const save = () => localStorage.setItem(KEY, JSON.stringify(violations));

                const render = () => {
                    tableBody.innerHTML = '';
                    if (violations.length === 0) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4">Belum ada data.</td></tr>`; return; }
                    violations.forEach(v => {
                        tableBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${v.name}</td><td class="px-6 py-4">${v.class}</td><td class="px-6 py-4">${v.type}</td><td class="px-6 py-4">${v.points}</td><td class="px-6 py-4">${v.date}</td><td class="px-6 py-4 flex space-x-2"><button class="edit-btn text-blue-600 font-medium hover:underline" data-id="${v.id}">Edit</button><button class="delete-btn text-red-600 font-medium hover:underline" data-id="${v.id}">Hapus</button></td></tr>`;
                    });
                };

                const openModal = (mode = 'create', id = null) => {
                    form.reset();
                    if (mode === 'create') {
                        modalTitle.textContent = 'Tambah Pelanggaran Baru';
                        idInput.value = '';
                        document.getElementById('pelanggaran_date').valueAsDate = new Date();
                    } else {
                        modalTitle.textContent = 'Edit Data Pelanggaran';
                        const v = violations.find(item => item.id === id);
                        idInput.value = v.id;
                        document.getElementById('pelanggaran_studentName').value = v.name;
                        document.getElementById('pelanggaran_studentClass').value = v.class;
                        document.getElementById('pelanggaran_violationType').value = v.type;
                        document.getElementById('pelanggaran_points').value = v.points;
                        document.getElementById('pelanggaran_date').value = v.date;
                    }
                    modal.classList.remove('hidden');
                };
                
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = {
                        id: idInput.value || Date.now().toString(),
                        name: document.getElementById('pelanggaran_studentName').value,
                        class: document.getElementById('pelanggaran_studentClass').value,
                        type: document.getElementById('pelanggaran_violationType').value,
                        points: document.getElementById('pelanggaran_points').value,
                        date: document.getElementById('pelanggaran_date').value,
                    };
                    if (idInput.value) {
                        const index = violations.findIndex(v => v.id === formData.id);
                        violations[index] = formData;
                    } else { violations.push(formData); }
                    save(); render(); modal.classList.add('hidden');
                    App.helpers.showToast('Data pelanggaran berhasil disimpan!');
                });

                tableBody.addEventListener('click', (e) => {
                    if (e.target.classList.contains('edit-btn')) openModal('edit', e.target.dataset.id);
                    if (e.target.classList.contains('delete-btn')) {
                        if (confirm('Yakin ingin hapus data ini?')) {
                            violations = violations.filter(v => v.id !== e.target.dataset.id);
                            save(); render();
                            App.helpers.showToast('Data berhasil dihapus!', 'error');
                        }
                    }
                });
                
                addBtn.addEventListener('click', () => openModal('create'));
                render();
            }
        },
        ppdb: {
            init: function() {
                const tableBody = document.getElementById('ppdb_applicantTableBody');
                const modal = document.getElementById('ppdb-modal');
                const filterStatus = document.getElementById('ppdb_filterStatus');
                const addBtn = document.getElementById('ppdb_addApplicantBtn');
                
                const KEY = 'ppdbApplicants';
                const getInitialData = () => [{id: 'PPDB2025001', nama: 'Citra Amelia', asalSekolah: 'SMP Negeri 1 Bandung', jalur: 'Prestasi', status: 'Diterima', dataDiri: { 'Nama Lengkap': 'Citra Amelia', 'NISN': '0081234567', 'Tempat, Tanggal Lahir': 'Bandung, 10-05-2010', 'Alamat': 'Jl. Merdeka No. 10' }, dataOrangTua: { 'Nama Ayah': 'Bambang S.', 'Pekerjaan Ayah': 'Wiraswasta', 'Nama Ibu': 'Rina M.', 'Pekerjaan Ibu': 'Ibu Rumah Tangga' }, berkas: ['Kartu Keluarga.pdf', 'Akta Kelahiran.pdf', 'Ijazah SMP.pdf', 'Sertifikat Lomba.pdf']}, {id: 'PPDB2025002', nama: 'Budi Hartono', asalSekolah: 'SMP Harapan Bangsa', jalur: 'Zonasi', status: 'Menunggu Verifikasi', dataDiri: { 'Nama Lengkap': 'Budi Hartono', 'NISN': '0087654321', 'Tempat, Tanggal Lahir': 'Cimahi, 12-01-2010', 'Alamat': 'Jl. Pasteur No. 15' }, dataOrangTua: { 'Nama Ayah': 'Haryanto', 'Pekerjaan Ayah': 'Pegawai Swasta', 'Nama Ibu': 'Siti Aminah', 'Pekerjaan Ibu': 'Guru' }, berkas: ['Kartu Keluarga.pdf', 'Akta Kelahiran.pdf', 'Surat Keterangan Lulus.pdf']}, {id: 'PPDB2025003', nama: 'Dewi Lestari', asalSekolah: 'SMP Pelita Jaya', jalur: 'Afirmasi', status: 'Lolos Verifikasi', dataDiri: { 'Nama Lengkap': 'Dewi Lestari', 'NISN': '0089988776', 'Tempat, Tanggal Lahir': 'Bandung, 25-08-2010', 'Alamat': 'Jl. Kopo No. 200' }, dataOrangTua: { 'Nama Ayah': 'Suparjo', 'Pekerjaan Ayah': 'Buruh Harian', 'Nama Ibu': 'Wati', 'Pekerjaan Ibu': 'Asisten Rumah Tangga' }, berkas: ['Kartu Keluarga.pdf', 'Akta Kelahiran.pdf', 'Ijazah SMP.pdf', 'Kartu KIP.pdf']}, {id: 'PPDB2025004', nama: 'Agung Setiawan', asalSekolah: 'SMP Negeri 5 Bandung', jalur: 'Prestasi', status: 'Ditolak', dataDiri: { 'Nama Lengkap': 'Agung Setiawan', 'NISN': '0081122334', 'Tempat, Tanggal Lahir': 'Jakarta, 01-02-2010', 'Alamat': 'Jl. Dago Atas No. 50' }, dataOrangTua: { 'Nama Ayah': 'Joko Widodo', 'Pekerjaan Ayah': 'Pengusaha', 'Nama Ibu': 'Sri Mulyani', 'Pekerjaan Ibu': 'Dokter' }, berkas: ['Kartu Keluarga.pdf', 'Akta Kelahiran.pdf', 'Ijazah SMP.pdf']}];
                let applicants = JSON.parse(localStorage.getItem(KEY)) || getInitialData();
                const save = () => localStorage.setItem(KEY, JSON.stringify(applicants));

                const getStatusBadge = (status) => {
                    const styles = {'Menunggu Verifikasi': 'bg-yellow-100 text-yellow-800', 'Lolos Verifikasi': 'bg-blue-100 text-blue-800', 'Diterima': 'bg-green-100 text-green-800', 'Ditolak': 'bg-red-100 text-red-800'};
                    return `<span class="px-2 py-1 text-xs font-medium rounded-full ${styles[status] || ''}">${status}</span>`;
                };
                const render = () => {
                    tableBody.innerHTML = '';
                    const filtered = applicants.filter(app => !filterStatus.value || app.status === filterStatus.value);
                    if (filtered.length === 0) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4">Tidak ada data.</td></tr>`; return; }
                    filtered.forEach(app => {
                        tableBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${app.id}</td><td class="px-6 py-4">${app.nama}</td><td class="px-6 py-4">${app.asalSekolah}</td><td class="px-6 py-4">${app.jalur}</td><td class="px-6 py-4">${getStatusBadge(app.status)}</td><td class="px-6 py-4 flex space-x-3"><button class="detail-btn font-medium text-blue-600 hover:underline" data-id="${app.id}">Detail</button><button class="delete-btn font-medium text-red-600 hover:underline" data-id="${app.id}">Hapus</button></td></tr>`;
                    });
                    document.getElementById('ppdb_statTotal').textContent = applicants.length;
                    document.getElementById('ppdb_statVerified').textContent = applicants.filter(a => a.status === 'Lolos Verifikasi').length;
                    document.getElementById('ppdb_statAccepted').textContent = applicants.filter(a => a.status === 'Diterima').length;
                    document.getElementById('ppdb_statRejected').textContent = applicants.filter(a => a.status === 'Ditolak').length;
                };
                
                const openDetailModal = (id) => {
                    const app = applicants.find(a => a.id === id);
                    document.getElementById('ppdb_modalTitle').textContent = `Detail: ${app.nama}`;
                    const renderData = (containerId, data) => {
                        const container = document.getElementById(containerId);
                        container.innerHTML = '';
                        for(const [key, value] of Object.entries(data)){ container.innerHTML += `<div class="col-span-2 sm:col-span-1"><p class="font-semibold text-gray-600">${key}</p><p>${value}</p></div>`; }
                    };
                    renderData('ppdb_dataDiri', app.dataDiri);
                    renderData('ppdb_dataOrangTua', app.dataOrangTua);
                    document.getElementById('ppdb_berkasList').innerHTML = app.berkas.map(b => `<li class="flex items-center text-blue-600"><ion-icon name="document-attach-outline" class="mr-2"></ion-icon><a href="#" class="hover:underline">${b}</a></li>`).join('');
                    const footer = document.getElementById('ppdb_modalActionFooter');
                    footer.dataset.id = id;
                    if (app.status === 'Menunggu Verifikasi') footer.innerHTML = `<button data-action="Lolos Verifikasi" class="action-btn bg-blue-500 text-white px-4 py-2 rounded-lg">Verifikasi Berkas</button>`;
                    else if (app.status === 'Lolos Verifikasi') footer.innerHTML = `<button data-action="Ditolak" class="action-btn bg-red-500 text-white px-4 py-2 rounded-lg">Tolak</button><button data-action="Diterima" class="action-btn bg-green-500 text-white px-4 py-2 rounded-lg">Terima Calon Siswa</button>`;
                    else footer.innerHTML = `<p class="text-sm text-gray-600">Proses selesai.</p>`;
                    modal.classList.remove('hidden');
                };
                
                tableBody.addEventListener('click', (e) => {
                    if (e.target.classList.contains('detail-btn')) openDetailModal(e.target.dataset.id);
                    if (e.target.classList.contains('delete-btn')) {
                        if (!confirm(`Hapus data pendaftar No. ${e.target.dataset.id}?`)) return;
                        applicants = applicants.filter(a => a.id !== e.target.dataset.id);
                        save(); render();
                        App.helpers.showToast('Data pendaftar dihapus!', 'error');
                    }
                });

                modal.addEventListener('click', (e) => {
                    if (e.target.classList.contains('action-btn')) {
                        const id = e.target.parentElement.dataset.id;
                        const newStatus = e.target.dataset.action;
                        if (!confirm(`Ubah status menjadi "${newStatus}"?`)) return;
                        applicants.find(a => a.id === id).status = newStatus;
                        save(); render(); modal.classList.add('hidden');
                        App.helpers.showToast(`Status berhasil diubah menjadi ${newStatus}!`);
                    }
                });

                addBtn.addEventListener('click', () => alert('Fungsi Tambah Pendaftar hanya demo.'));
                filterStatus.addEventListener('change', render);
                render();
            }
        },
        keuangan: {
            init: function() {
                const tableBody = document.getElementById('keuangan_studentFinanceTableBody');
                const modal = document.getElementById('keuangan-modal');
                const form = document.getElementById('keuangan_newPaymentForm');
                
                const KEY = 'schoolFinanceData';
                const getInitialData = () => [{id: '101', nama: 'Budi Santoso', kelas: '10 IPA 1', tagihan: [{ id: 't1', deskripsi: 'SPP Agustus 2025', jumlah: 500000 }, { id: 't2', deskripsi: 'Uang Buku Semester 1', jumlah: 750000 }, { id: 't3', deskripsi: 'Uang Kegiatan 17an', jumlah: 50000 }], pembayaran: [{ id: Date.now() + 1, tanggal: '2025-08-05', deskripsi: 'SPP Agustus 2025', jumlah: 500000, metode: 'Transfer Bank' }]}, {id: '102', nama: 'Ani Lestari', kelas: '11 IPS 2', tagihan: [{ id: 't4', deskripsi: 'SPP Agustus 2025', jumlah: 550000 }, { id: 't5', deskripsi: 'Uang Study Tour', jumlah: 1200000 },], pembayaran: [{ id: Date.now() + 2, tanggal: '2025-08-10', deskripsi: 'Uang Study Tour', jumlah: 1200000, metode: 'Cash' }, { id: Date.now() + 3, tanggal: '2025-08-10', deskripsi: 'SPP Agustus 2025', jumlah: 550000, metode: 'Cash' }]}, {id: '103', nama: 'Eko Prasetyo', kelas: '12 Bahasa', tagihan: [{ id: 't6', deskripsi: 'SPP Agustus 2025', jumlah: 525000 }, { id: 't7', deskripsi: 'Uang Buku LKS', jumlah: 250000 },], pembayaran: []}];
                let financeData = JSON.parse(localStorage.getItem(KEY)) || getInitialData();
                const save = () => localStorage.setItem(KEY, JSON.stringify(financeData));

                const calculateTotals = (student) => {
                    const totalTagihan = student.tagihan.reduce((sum, t) => sum + t.jumlah, 0);
                    const totalTerbayar = student.pembayaran.reduce((sum, p) => sum + p.jumlah, 0);
                    return { totalTagihan, totalTerbayar, sisaTunggakan: totalTagihan - totalTerbayar };
                };
                const render = () => {
                    tableBody.innerHTML = '';
                    let totalIncome = 0, totalBills = 0, paidOffCount = 0;
                    financeData.forEach(student => {
                        const { totalTagihan, totalTerbayar, sisaTunggakan } = calculateTotals(student);
                        totalIncome += totalTerbayar;
                        totalBills += totalTagihan;
                        if (sisaTunggakan <= 0) paidOffCount++;
                        const statusLunas = sisaTunggakan <= 0;
                        const statusClass = statusLunas ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        tableBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${student.nama}</td><td class="px-6 py-4">${student.kelas}</td><td class="px-6 py-4">${App.helpers.formatRupiah(totalTagihan)}</td><td class="px-6 py-4">${App.helpers.formatRupiah(totalTerbayar)}</td><td class="px-6 py-4 font-semibold ${sisaTunggakan > 0 ? 'text-red-600' : 'text-gray-800'}">${App.helpers.formatRupiah(sisaTunggakan)}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${statusLunas ? 'Lunas' : 'Belum Lunas'}</span></td><td class="px-6 py-4"><button class="detail-btn font-medium text-blue-600 hover:underline" data-id="${student.id}">Lihat Detail</button></td></tr>`;
                    });
                    document.getElementById('keuangan_totalIncome').textContent = App.helpers.formatRupiah(totalIncome);
                    document.getElementById('keuangan_totalOutstanding').textContent = App.helpers.formatRupiah(totalBills - totalIncome);
                    document.getElementById('keuangan_paidOffStudents').textContent = `${paidOffCount} / ${financeData.length}`;
                };
                
                const renderPaymentHistory = (studentId) => {
                    const student = financeData.find(s => s.id === studentId);
                    const container = document.getElementById('keuangan_paymentHistoryContainer');
                    container.innerHTML = '';
                    if (student.pembayaran.length === 0) { container.innerHTML = '<p class="text-center text-gray-500">Belum ada riwayat pembayaran.</p>'; return; }
                    const sortedPayments = [...student.pembayaran].sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));
                    sortedPayments.forEach(p => {
                        container.innerHTML += `<div class="border rounded-lg p-3 mb-3 bg-white"><div class="flex justify-between items-start"><div><p class="font-bold text-gray-800">${p.deskripsi}</p><p class="text-sm text-gray-500">${p.tanggal} • ${p.metode}</p></div><p class="font-semibold text-green-600 text-lg">${App.helpers.formatRupiah(p.jumlah)}</p></div><div class="flex justify-end items-center mt-2 space-x-3 text-xs"><button class="edit-payment-btn font-medium text-blue-600 hover:underline" data-student-id="${student.id}" data-payment-id="${p.id}">Edit</button><button class="delete-payment-btn font-medium text-red-600 hover:underline" data-student-id="${student.id}" data-payment-id="${p.id}">Hapus</button></div></div>`;
                    });
                };

                const openDetailModal = (studentId) => {
                    const student = financeData.find(s => s.id === studentId);
                    document.getElementById('keuangan_modalStudentInfo').textContent = `${student.nama} - ${student.kelas}`;
                    document.getElementById('keuangan_currentStudentId').value = studentId;
                    form.reset();
                    document.getElementById('keuangan_paymentId').value = '';
                    document.getElementById('keuangan_paymentDate').valueAsDate = new Date();
                    const paymentTypeSelect = document.getElementById('keuangan_paymentType');
                    paymentTypeSelect.innerHTML = '';
                    student.tagihan.forEach(t => {
                        const isPaid = student.pembayaran.some(p => p.deskripsi === t.deskripsi && p.jumlah >= t.jumlah);
                        if (!isPaid) paymentTypeSelect.innerHTML += `<option value="${t.deskripsi}" data-amount="${t.jumlah}">${t.deskripsi}</option>`;
                    });
                    const autoFillAmount = () => {
                        const selectedOption = paymentTypeSelect.options[paymentTypeSelect.selectedIndex];
                        document.getElementById('keuangan_paymentAmount').value = selectedOption ? selectedOption.dataset.amount : '';
                    };
                    paymentTypeSelect.onchange = autoFillAmount;
                    autoFillAmount();
                    renderPaymentHistory(studentId);
                    modal.classList.remove('hidden');
                };

                tableBody.addEventListener('click', (e) => {
                    if (e.target.classList.contains('detail-btn')) openDetailModal(e.target.dataset.id);
                });

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const studentId = document.getElementById('keuangan_currentStudentId').value;
                    const paymentId = document.getElementById('keuangan_paymentId').value;
                    const student = financeData.find(s => s.id === studentId);
                    const paymentData = {
                        id: paymentId || Date.now().toString(),
                        tanggal: document.getElementById('keuangan_paymentDate').value,
                        deskripsi: document.getElementById('keuangan_paymentType').value,
                        jumlah: parseInt(document.getElementById('keuangan_paymentAmount').value),
                        metode: document.getElementById('keuangan_paymentMethod').value,
                    };
                    if (paymentId) {
                        const pIndex = student.pembayaran.findIndex(p => p.id === paymentId);
                        student.pembayaran[pIndex] = paymentData;
                    } else { student.pembayaran.push(paymentData); }
                    save(); render(); renderPaymentHistory(studentId); form.reset();
                    document.getElementById('keuangan_paymentDate').valueAsDate = new Date();
                    App.helpers.showToast('Pembayaran berhasil disimpan!');
                });

                document.getElementById('keuangan_paymentHistoryContainer').addEventListener('click', (e) => {
                    const { studentId, paymentId } = e.target.dataset;
                    const student = financeData.find(s => s.id === studentId);
                    if (e.target.classList.contains('edit-payment-btn')) {
                        const payment = student.pembayaran.find(p => p.id.toString() === paymentId);
                        document.getElementById('keuangan_paymentId').value = payment.id;
                        document.getElementById('keuangan_paymentType').value = payment.deskripsi;
                        document.getElementById('keuangan_paymentAmount').value = payment.jumlah;
                        document.getElementById('keuangan_paymentMethod').value = payment.metode;
                        document.getElementById('keuangan_paymentDate').value = payment.tanggal;
                    }
                    if (e.target.classList.contains('delete-payment-btn')) {
                        if (!confirm('Yakin ingin hapus catatan pembayaran ini?')) return;
                        student.pembayaran = student.pembayaran.filter(p => p.id.toString() !== paymentId);
                        save(); render(); renderPaymentHistory(studentId);
                        App.helpers.showToast('Catatan pembayaran dihapus!', 'error');
                    }
                });
                render();
            }
        },
        akademik: {
            init: function() {
                const classSelect = document.getElementById('akademik_classSelect');
                const subjectSelect = document.getElementById('akademik_subjectSelect');
                const tableBody = document.getElementById('akademik_gradeTableBody');
                const saveBtn = document.getElementById('akademik_saveGradesBtn');
                
                const KEY = 'schoolGrades';
                const WEIGHTS = { tugas: 0.2, harian: 0.2, uts: 0.3, uas: 0.3 };
                let allGrades = JSON.parse(localStorage.getItem(KEY)) || {};
                const save = () => localStorage.setItem(KEY, JSON.stringify(allGrades));

                const calculateFinalGrade = (grades) => {
                    const { tugas = 0, harian = 0, uts = 0, uas = 0 } = grades;
                    const final = (tugas * WEIGHTS.tugas) + (harian * WEIGHTS.harian) + (uts * WEIGHTS.uts) + (uas * WEIGHTS.uas);
                    return final.toFixed(1);
                };
                const render = () => {
                    const selectedClass = classSelect.value;
                    const selectedSubject = subjectSelect.value;
                    const students = App.masterData.siswa[selectedClass];
                    if (!selectedClass || !selectedSubject || !students) {
                        tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">Pilih kelas dan mata pelajaran.</td></tr>`;
                        return;
                    }
                    const storageKey = `${selectedClass}_${selectedSubject}`;
                    const currentGrades = allGrades[storageKey] || [];
                    tableBody.innerHTML = '';
                    students.forEach(studentName => {
                        const studentGradeData = currentGrades.find(g => g.nama === studentName) || { nama: studentName };
                        const finalGrade = calculateFinalGrade(studentGradeData);
                        tableBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50" data-student-name="${studentName}"><td class="px-6 py-4 font-medium text-gray-900">${studentName}</td><td class="px-2 py-2"><input type="number" class="w-20 text-center border rounded py-1 grade-input" data-type="tugas" value="${studentGradeData.tugas || ''}" min="0" max="100"></td><td class="px-2 py-2"><input type="number" class="w-20 text-center border rounded py-1 grade-input" data-type="harian" value="${studentGradeData.harian || ''}" min="0" max="100"></td><td class="px-2 py-2"><input type="number" class="w-20 text-center border rounded py-1 grade-input" data-type="uts" value="${studentGradeData.uts || ''}" min="0" max="100"></td><td class="px-2 py-2"><input type="number" class="w-20 text-center border rounded py-1 grade-input" data-type="uas" value="${studentGradeData.uas || ''}" min="0" max="100"></td><td class="px-6 py-4 text-center font-bold text-lg ${finalGrade >= 75 ? 'text-green-600' : 'text-red-600'} final-grade">${finalGrade}</td></tr>`;
                    });
                };
                
                const updateFinalGradeInRow = (rowElement) => {
                    const grades = {};
                    rowElement.querySelectorAll('.grade-input').forEach(input => { grades[input.dataset.type] = parseFloat(input.value) || 0; });
                    const finalGradeCell = rowElement.querySelector('.final-grade');
                    const finalGrade = calculateFinalGrade(grades);
                    finalGradeCell.textContent = finalGrade;
                    finalGradeCell.className = `px-6 py-4 text-center font-bold text-lg ${finalGrade >= 75 ? 'text-green-600' : 'text-red-600'} final-grade`;
                };
                
                classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>' + Object.keys(App.masterData.siswa).map(c => `<option value="${c}">${c}</option>`).join('');
                subjectSelect.innerHTML = '<option value="">-- Pilih Mapel --</option>' + App.masterData.mapel.map(s => `<option value="${s}">${s}</option>`).join('');
                
                classSelect.addEventListener('change', render);
                subjectSelect.addEventListener('change', render);
                tableBody.addEventListener('input', (e) => { if (e.target.classList.contains('grade-input')) updateFinalGradeInRow(e.target.closest('tr')); });
                saveBtn.addEventListener('click', () => {
                    const storageKey = `${classSelect.value}_${subjectSelect.value}`;
                    const newGrades = [];
                    tableBody.querySelectorAll('tr').forEach(row => {
                        const studentName = row.dataset.studentName;
                        if(studentName) {
                            const studentData = { nama: studentName };
                            row.querySelectorAll('.grade-input').forEach(input => { if(input.value) studentData[input.dataset.type] = parseFloat(input.value); });
                            newGrades.push(studentData);
                        }
                    });
                    allGrades[storageKey] = newGrades;
                    save();
                    App.helpers.showToast('Semua perubahan nilai berhasil disimpan!');
                });
                render();
            }
        },
        absensi_siswa: {
            init: function() {
                const addBtn = document.getElementById('absensiSiswa_addAttendanceBtn');
                const modal = document.getElementById('absensi_siswa-modal');
                const saveBtn = document.getElementById('absensiSiswa_saveAttendanceBtn');
                const historyTableBody = document.getElementById('absensiSiswa_attendanceHistoryTableBody');
                const modalTitle = document.getElementById('absensiSiswa_modalTitle');
                const classSelect = document.getElementById('absensiSiswa_classSelect');
                const dateInput = document.getElementById('absensiSiswa_attendanceDate');
                const studentListContainer = document.getElementById('absensiSiswa_studentListContainer');
                
                const KEY = 'schoolAttendances';
                let attendances = JSON.parse(localStorage.getItem(KEY)) || [];
                const save = () => localStorage.setItem(KEY, JSON.stringify(attendances));

                const render = () => {
                    historyTableBody.innerHTML = '';
                    if (attendances.length === 0) { historyTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4">Belum ada riwayat absensi.</td></tr>`; return; }
                    const sorted = [...attendances].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
                    sorted.forEach(att => {
                        historyTableBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${att.tanggal}</td><td class="px-6 py-4">${att.kelas}</td><td class="px-6 py-4 text-center font-semibold text-green-600">${att.rekap.hadir}</td><td class="px-6 py-4 text-center font-semibold text-yellow-600">${att.rekap.sakit}</td><td class="px-6 py-4 text-center font-semibold text-blue-600">${att.rekap.izin}</td><td class="px-6 py-4 text-center font-semibold text-red-600">${att.rekap.alpha}</td><td class="px-6 py-4 flex space-x-2"><button class="edit-btn font-medium text-blue-600 hover:underline" data-id="${att.id}">Edit</button><button class="delete-btn font-medium text-red-600 hover:underline" data-id="${att.id}">Hapus</button></td></tr>`;
                    });
                };
                
                const populateStudentList = (kelas, existingDetails = null) => {
                    const students = App.masterData.siswa[kelas];
                    if (!students) { studentListContainer.innerHTML = '<p class="text-center text-gray-500">Data siswa tidak ditemukan.</p>'; return; }
                    studentListContainer.innerHTML = students.map((studentName, index) => {
                        const studentId = `student-${index}`;
                        const existingStatus = existingDetails ? existingDetails.find(d => d.nama === studentName)?.status : 'Hadir';
                        const isChecked = (status) => existingStatus === status ? 'checked' : '';
                        return `<div class="flex items-center justify-between py-3 border-b"><span class="text-gray-800">${studentName}</span><div class="flex items-center space-x-2" data-student-name="${studentName}"><input type="radio" id="${studentId}-h" name="${studentId}" value="Hadir" class="hidden custom-radio" ${isChecked('Hadir')}><label for="${studentId}-h" class="cursor-pointer text-sm font-semibold py-1 px-3 rounded-full border-2">Hadir</label><input type="radio" id="${studentId}-s" name="${studentId}" value="Sakit" class="hidden custom-radio" ${isChecked('Sakit')}><label for="${studentId}-s" class="cursor-pointer text-sm font-semibold py-1 px-3 rounded-full border-2">Sakit</label><input type="radio" id="${studentId}-i" name="${studentId}" value="Izin" class="hidden custom-radio" ${isChecked('Izin')}><label for="${studentId}-i" class="cursor-pointer text-sm font-semibold py-1 px-3 rounded-full border-2">Izin</label><input type="radio" id="${studentId}-a" name="${studentId}" value="Alpha" class="hidden custom-radio" ${isChecked('Alpha')}><label for="${studentId}-a" class="cursor-pointer text-sm font-semibold py-1 px-3 rounded-full border-2">Alpha</label></div></div>`;
                    }).join('');
                };

                const openModal = (mode = 'create', id = null) => {
                    if (mode === 'create') {
                        modalTitle.textContent = 'Buat Absensi Kelas';
                        classSelect.disabled = false; dateInput.disabled = false;
                        classSelect.value = ''; dateInput.valueAsDate = new Date();
                        studentListContainer.innerHTML = '<p class="text-center text-gray-500">Pilih kelas dan tanggal.</p>';
                    } else {
                        const att = attendances.find(a => a.id === id);
                        modalTitle.textContent = `Edit Absensi Kelas ${att.kelas}`;
                        classSelect.value = att.kelas; dateInput.value = att.tanggal;
                        classSelect.disabled = true; dateInput.disabled = true;
                        populateStudentList(att.kelas, att.detail);
                    }
                    modal.classList.remove('hidden');
                };

                saveBtn.addEventListener('click', () => {
                    const kelas = classSelect.value, tanggal = dateInput.value;
                    if (!kelas || !tanggal) { alert('Pilih kelas dan tanggal.'); return; }
                    const id = `${kelas}_${tanggal}`, detail = [], rekap = { hadir: 0, sakit: 0, izin: 0, alpha: 0 };
                    studentListContainer.querySelectorAll('[data-student-name]').forEach(div => {
                        const nama = div.dataset.studentName, status = div.querySelector('input:checked').value;
                        detail.push({ nama, status }); rekap[status.toLowerCase()]++;
                    });
                    const newAtt = { id, kelas, tanggal, rekap, detail };
                    const existingIndex = attendances.findIndex(att => att.id === id);
                    if (existingIndex > -1) attendances[existingIndex] = newAtt;
                    else attendances.push(newAtt);
                    save(); render(); modal.classList.add('hidden');
                    App.helpers.showToast('Absensi berhasil disimpan!');
                });

                classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>' + Object.keys(App.masterData.siswa).map(c => `<option value="${c}">${c}</option>`).join('');
                addBtn.addEventListener('click', () => openModal('create'));
                classSelect.addEventListener('change', () => { if(classSelect.value) populateStudentList(classSelect.value); });
                historyTableBody.addEventListener('click', (e) => {
                    if(e.target.classList.contains('edit-btn')) openModal('edit', e.target.dataset.id);
                    if(e.target.classList.contains('delete-btn')) {
                        if(!confirm('Yakin ingin hapus absensi ini?')) return;
                        attendances = attendances.filter(a => a.id !== e.target.dataset.id);
                        save(); render();
                        App.helpers.showToast('Absensi dihapus!', 'error');
                    }
                });
                render();
            }
        },
        absensi_guru: {
            init: function() {
                const dateFilter = document.getElementById('absensiGuru_date-filter');
                const rekapTableBody = document.getElementById('absensiGuru_rekapTableBody');
                const izinTableBody = document.getElementById('absensiGuru_izinTableBody');
                const modal = document.getElementById('absensi_guru-modal');
                const form = document.getElementById('absensiGuru_editForm');
                
                const KEY_ATT = 'teacherAttendance', KEY_LEAVE = 'teacherLeaveRequests';
                const getInitialData = () => {
                    const today = App.helpers.getToday();
                    return {
                        att: [{ id: 'att1', teacherId: 'G01', tanggal: today, jamMasuk: '07:10', jamPulang: '15:25', status: 'Hadir'}, { id: 'att2', teacherId: 'G02', tanggal: today, jamMasuk: '07:15', jamPulang: '15:30', status: 'Hadir'}, { id: 'att3', teacherId: 'G03', tanggal: today, status: 'Sakit'}],
                        leave: [{ id: 'leave1', teacherId: 'G04', teacherName: 'Agus Wijayanto, S.S.', jenis: 'Izin Penting', tanggalMulai: '2025-08-25', tanggalSelesai: '2025-08-25', keterangan: 'Acara keluarga.', status: 'Pending' }]
                    };
                };
                let attendanceData = JSON.parse(localStorage.getItem(KEY_ATT)) || getInitialData().att;
                let leaveRequests = JSON.parse(localStorage.getItem(KEY_LEAVE)) || getInitialData().leave;
                const saveAtt = () => localStorage.setItem(KEY_ATT, JSON.stringify(attendanceData));
                const saveLeave = () => localStorage.setItem(KEY_LEAVE, JSON.stringify(leaveRequests));

                const getStatusBadge = (status) => {
                    const styles = { 'Hadir': 'bg-green-100 text-green-800', 'Sakit': 'bg-yellow-100 text-yellow-800', 'Izin': 'bg-blue-100 text-blue-800', 'Cuti': 'bg-purple-100 text-purple-800', 'Alpha': 'bg-red-100 text-red-800' };
                    return `<span class="px-2 py-1 text-xs font-medium rounded-full ${styles[status] || ''}">${status}</span>`;
                };
                const calculateDuration = (start, end) => {
                    if (!start || !end) return '-';
                    const diff = (new Date(`1970-01-01T${end}:00`) - new Date(`1970-01-01T${start}:00`)) / 60000;
                    if (diff < 0) return '-';
                    return `${Math.floor(diff / 60)} jam ${diff % 60} mnt`;
                };
                const renderRecap = (date) => {
                    rekapTableBody.innerHTML = '';
                    let hadirCount = 0;
                    App.masterData.guru.forEach(guru => {
                        let record = attendanceData.find(a => a.teacherId === guru.id && a.tanggal === date);
                        const onLeave = leaveRequests.find(l => l.teacherId === guru.id && l.status === 'Disetujui' && date >= l.tanggalMulai && date <= l.tanggalSelesai);
                        if (onLeave && !record) record = { status: onLeave.jenis };
                        const status = record ? record.status : 'Alpha';
                        if (status === 'Hadir') hadirCount++;
                        rekapTableBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${guru.nama}</td><td class="px-6 py-4">${record?.jamMasuk || '-'}</td><td class="px-6 py-4">${record?.jamPulang || '-'}</td><td class="px-6 py-4">${calculateDuration(record?.jamMasuk, record?.jamPulang)}</td><td class="px-6 py-4">${getStatusBadge(status)}</td><td class="px-6 py-4"><button class="edit-btn font-medium text-blue-600 hover:underline" data-teacher-id="${guru.id}" data-teacher-name="${guru.nama}" data-date="${date}">Edit</button></td></tr>`;
                    });
                    document.getElementById('absensiGuru_statTotal').textContent = App.masterData.guru.length;
                    document.getElementById('absensiGuru_statHadir').textContent = hadirCount;
                    document.getElementById('absensiGuru_statTidakHadir').textContent = App.masterData.guru.length - hadirCount;
                };
                const renderLeave = () => {
                    const pending = leaveRequests.filter(r => r.status === 'Pending');
                    document.getElementById('absensiGuru_izin-count').textContent = pending.length;
                    izinTableBody.innerHTML = '';
                    if (pending.length === 0) { izinTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-gray-500">Tidak ada pengajuan baru.</td></tr>`; return; }
                    pending.forEach(req => {
                        izinTableBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${req.teacherName}</td><td class="px-6 py-4">${req.jenis}</td><td class="px-6 py-4">${req.tanggalMulai} s/d ${req.tanggalSelesai}</td><td class="px-6 py-4">${req.keterangan}</td><td class="px-6 py-4 flex space-x-2"><button class="action-btn bg-red-100 text-red-700 text-xs font-bold py-1 px-3 rounded-full hover:bg-red-200" data-id="${req.id}" data-action="Ditolak">Tolak</button><button class="action-btn bg-green-100 text-green-700 text-xs font-bold py-1 px-3 rounded-full hover:bg-green-200" data-id="${req.id}" data-action="Disetujui">Setujui</button></td></tr>`;
                    });
                };
                
                const openModal = ({ teacherId, teacherName, date }) => {
                    const record = attendanceData.find(a => a.teacherId === teacherId && a.tanggal === date) || {};
                    document.getElementById('absensiGuru_editModalInfo').textContent = `${teacherName} - ${date}`;
                    document.getElementById('absensiGuru_editTeacherId').value = teacherId;
                    document.getElementById('absensiGuru_editDate').value = date;
                    const statusSelect = document.getElementById('absensiGuru_editStatus');
                    statusSelect.innerHTML = ['Hadir', 'Sakit', 'Izin', 'Cuti', 'Alpha'].map(s => `<option value="${s}" ${s === (record.status || 'Alpha') ? 'selected' : ''}>${s}</option>`).join('');
                    document.getElementById('absensiGuru_editJamMasuk').value = record.jamMasuk || '';
                    document.getElementById('absensiGuru_editJamPulang').value = record.jamPulang || '';
                    const toggleJam = (status) => document.getElementById('absensiGuru_jamContainer').style.display = status === 'Hadir' ? 'grid' : 'none';
                    statusSelect.onchange = (e) => toggleJam(e.target.value);
                    toggleJam(statusSelect.value);
                    modal.classList.remove('hidden');
                };
                
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const teacherId = document.getElementById('absensiGuru_editTeacherId').value;
                    const date = document.getElementById('absensiGuru_editDate').value;
                    const status = document.getElementById('absensiGuru_editStatus').value;
                    let record = attendanceData.find(a => a.teacherId === teacherId && a.tanggal === date);
                    if (!record) { record = { id: `att_${Date.now()}`, teacherId, tanggal: date }; attendanceData.push(record); }
                    record.status = status;
                    record.jamMasuk = document.getElementById('absensiGuru_editJamMasuk').value;
                    record.jamPulang = document.getElementById('absensiGuru_editJamPulang').value;
                    saveAtt(); renderRecap(dateFilter.value); modal.classList.add('hidden');
                    App.helpers.showToast('Absensi guru berhasil diperbarui!');
                });

                rekapTableBody.addEventListener('click', (e) => { if (e.target.classList.contains('edit-btn')) openModal(e.target.dataset); });
                izinTableBody.addEventListener('click', (e) => {
                    if (e.target.classList.contains('action-btn')) {
                        const { id, action } = e.target.dataset;
                        if (!confirm(`Yakin ingin ${action === 'Disetujui' ? 'menyetujui' : 'menolak'} pengajuan ini?`)) return;
                        leaveRequests.find(r => r.id === id).status = action;
                        saveLeave(); renderLeave(); renderRecap(dateFilter.value);
                        App.helpers.showToast(`Pengajuan berhasil ${action.toLowerCase()}!`);
                    }
                });

                dateFilter.value = App.helpers.getToday();
                dateFilter.addEventListener('change', () => renderRecap(dateFilter.value));
                const tabs = { rekap: document.getElementById('absensiGuru_tab-rekap'), izin: document.getElementById('absensiGuru_tab-izin') };
                const contents = { rekap: document.getElementById('absensiGuru_content-rekap'), izin: document.getElementById('absensiGuru_content-izin') };
                const switchTab = (active) => {
                    Object.keys(tabs).forEach(key => {
                        const isActive = key === active;
                        tabs[key].className = isActive ? 'border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm';
                        contents[key].classList.toggle('hidden', !isActive);
                    });
                };
                tabs.rekap.addEventListener('click', (e) => { e.preventDefault(); switchTab('rekap'); });
                tabs.izin.addEventListener('click', (e) => { e.preventDefault(); switchTab('izin'); });

                renderRecap(dateFilter.value);
                renderLeave();
            }
        },
        buku_tamu: {
            init: function() {
                const dateFilter = document.getElementById('bukuTamu_date-filter');
                const tableBody = document.getElementById('bukuTamu_guestTableBody');
                const modal = document.getElementById('buku_tamu-modal');
                const addBtn = document.getElementById('bukuTamu_addGuestBtn');
                const form = document.getElementById('bukuTamu_addGuestForm');

                const KEY = 'schoolGuestLog';
                const getInitialData = () => {
                    const today = App.helpers.getToday();
                    const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
                    return [{ id: `guest_1`, tanggal: today, waktuMasuk: '09:15', nama: 'Arief Budiman', instansi: 'Dinas Pendidikan', bertemu: 'Dr. Indah Permata, M.Pd.', tujuan: 'Rapat Koordinasi', waktuKeluar: '10:30', status: 'Sudah Keluar' }, { id: `guest_2`, tanggal: today, waktuMasuk: '11:00', nama: 'Rina Wati', instansi: 'Orang Tua Murid', bertemu: 'Bambang Subagio, S.Kom.', tujuan: 'Konsultasi nilai anak', waktuKeluar: null, status: 'Masih di Lokasi' }, { id: `guest_3`, tanggal: yesterday, waktuMasuk: '13:00', nama: 'CV Percetakan Maju', instansi: 'Vendor', bertemu: 'Bagian TU', tujuan: 'Pengantaran dokumen', waktuKeluar: '13:10', status: 'Sudah Keluar' }];
                };
                let guestLog = JSON.parse(localStorage.getItem(KEY)) || getInitialData();
                const save = () => localStorage.setItem(KEY, JSON.stringify(guestLog));
                
                const getStatusBadge = (status) => {
                    const styles = {'Masih di Lokasi': 'bg-blue-100 text-blue-800', 'Sudah Keluar': 'bg-gray-100 text-gray-800'};
                    return `<span class="px-2 py-1 text-xs font-medium rounded-full ${styles[status] || ''}">${status}</span>`;
                };

                const render = (date) => {
                    tableBody.innerHTML = '';
                    const dailyGuests = guestLog.filter(g => g.tanggal === date).sort((a,b) => b.id.split('_')[1] - a.id.split('_')[1]);
                    if (dailyGuests.length === 0) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-6">Belum ada tamu.</td></tr>`; }
                    else {
                        dailyGuests.forEach(guest => {
                            const checkoutButton = guest.status === 'Masih di Lokasi' ? `<button class="checkout-btn bg-green-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-green-600" data-id="${guest.id}">Check-out</button>` : `<span class="text-gray-400">Selesai</span>`;
                            tableBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-bold text-gray-900">${guest.waktuMasuk}</td><td class="px-6 py-4 font-medium text-gray-800">${guest.nama}<p class="font-normal text-gray-500">${guest.instansi}</p></td><td class="px-6 py-4">${guest.bertemu}</td><td class="px-6 py-4">${guest.tujuan}</td><td class="px-6 py-4 font-bold text-gray-900">${guest.waktuKeluar || '-'}</td><td class="px-6 py-4">${getStatusBadge(guest.status)}</td><td class="px-6 py-4 text-center">${checkoutButton}</td></tr>`;
                        });
                    }
                    document.getElementById('bukuTamu_statTotal').textContent = dailyGuests.length;
                    document.getElementById('bukuTamu_statCurrent').textContent = dailyGuests.filter(g => g.status === 'Masih di Lokasi').length;
                };

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const now = new Date();
                    const newGuest = {
                        id: `guest_${Date.now()}`,
                        tanggal: now.toISOString().slice(0, 10),
                        waktuMasuk: now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                        nama: document.getElementById('bukuTamu_guestName').value,
                        instansi: document.getElementById('bukuTamu_guestOrigin').value,
                        bertemu: document.getElementById('bukuTamu_guestMeeting').value,
                        tujuan: document.getElementById('bukuTamu_guestPurpose').value,
                        waktuKeluar: null,
                        status: 'Masih di Lokasi'
                    };
                    guestLog.push(newGuest);
                    save();
                    dateFilter.value = newGuest.tanggal;
                    render(newGuest.tanggal);
                    modal.classList.add('hidden');
                    App.helpers.showToast('Tamu berhasil check-in!');
                });

                tableBody.addEventListener('click', (e) => {
                    if (e.target.classList.contains('checkout-btn')) {
                        const guestId = e.target.dataset.id;
                        const guestIndex = guestLog.findIndex(g => g.id === guestId);
                        if (guestIndex > -1) {
                            const now = new Date();
                            guestLog[guestIndex].waktuKeluar = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                            guestLog[guestIndex].status = 'Sudah Keluar';
                            save();
                            render(dateFilter.value);
                            App.helpers.showToast('Tamu berhasil check-out!');
                        }
                    }
                });

                dateFilter.value = App.helpers.getToday();
                dateFilter.addEventListener('change', () => render(dateFilter.value));
                addBtn.addEventListener('click', () => { form.reset(); modal.classList.remove('hidden'); });
                render(dateFilter.value);
            }
        },

        // =================================================================
        // INISIALISASI APLIKASI UTAMA
        // =================================================================
        init: function() {
            this.templates.injectAll();
            this.navigation.init();
            
            // Inisialisasi semua modul
            this.ppdb.init();
            this.keuangan.init();
            this.akademik.init();
            this.absensi_siswa.init();
            this.pelanggaran.init();
            this.absensi_guru.init();
            this.buku_tamu.init();
            
            this.navigation.navigateTo('dashboard');
        }
    };
    
    // [START] KODE LENGKAP TEMPLATE DAN LOGIKA
    // (Kode ini sengaja dikosongkan karena sudah didefinisikan di dalam object App)
    
    // [END] KODE LENGKAP TEMPLATE DAN LOGIKA

    // =================================================================
    // APLIKASI UTAMA
    // =================================================================
    App.init();

    // Menutup semua modal saat tombol 'cancel' atau area luar diklik
    document.body.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal') || e.target.classList.contains('close-modal-btn') || e.target.classList.contains('cancel-modal-btn')) {
            document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
        }
    });
});
</script>
</body>
</html>
