<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Akademik - Aplikasi Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <style>
        .modal { transition: opacity 0.25s ease; }
        .sidebar-link.active { background-color: #3b82f6; color: white; font-weight: 600; }
        .toast { transition: opacity 0.3s ease, transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen">
        <div id="sidebar-placeholder"></div>
        
        <main class="flex-1 overflow-y-auto p-6 md:p-10">
            <header><h1 class="text-3xl font-bold text-gray-900">Manajemen Nilai Akademik</h1><p class="text-gray-600 mt-1">Input dan kelola nilai siswa per mata pelajaran dengan mudah.</p></header>
            <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="text-xl font-semibold text-gray-800">Daftar Nilai Siswa</h3>
                    <div class="flex items-center gap-4 w-full md:w-auto"><select id="classSelect" class="border rounded py-2 px-3 text-sm w-full"></select><select id="subjectSelect" class="border rounded py-2 px-3 text-sm w-full"></select></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 w-1/4">Nama Siswa</th>
                                <th class="px-3 py-3 text-center">Tugas (20%)</th>
                                <th class="px-3 py-3 text-center">Harian (20%)</th>
                                <th class="px-3 py-3 text-center">UTS (30%)</th>
                                <th class="px-3 py-3 text-center">UAS (30%)</th>
                                <th class="px-6 py-3 text-center">Nilai Akhir</th>
                            </tr>
                        </thead>
                        <tbody id="gradeTableBody"></tbody>
                    </table>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="saveGradesBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg flex items-center">
                        <ion-icon name="save-outline" class="mr-2"></ion-icon>
                        Simpan Semua Perubahan
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Tidak ada modal untuk halaman ini -->

    <div id="toast-container" class="fixed bottom-10 right-10 z-50"></div>

    <script src="../assets/app.js"></script>
    <script src="../assets/sidebar-sub.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const classSelect = document.getElementById('classSelect');
            const subjectSelect = document.getElementById('subjectSelect');
            const tableBody = document.getElementById('gradeTableBody');
            const saveBtn = document.getElementById('saveGradesBtn');
            
            const KEY = 'schoolGrades';
            const WEIGHTS = { tugas: 0.2, harian: 0.2, uts: 0.3, uas: 0.3 };
            let allGrades = JSON.parse(localStorage.getItem(KEY)) || {};
            const save = () => localStorage.setItem(KEY, JSON.stringify(allGrades));

            const calculateFinalGrade = (grades) => {
                const { tugas = 0, harian = 0, uts = 0, uas = 0 } = grades;
                const final = (tugas * WEIGHTS.tugas) + (harian * WEIGHTS.harian) + (uts * WEIGHTS.uts) + (uas * WEIGHTS.uas);
                return final.toFixed(1);
            };

            const render = () => {
                const selectedClass = classSelect.value;
                const selectedSubject = subjectSelect.value;
                const students = App.masterData.siswa[selectedClass];
                if (!selectedClass || !selectedSubject || !students) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">Pilih kelas dan mata pelajaran untuk mulai.</td></tr>`;
                    return;
                }
                const storageKey = `${selectedClass}_${selectedSubject}`;
                const currentGrades = allGrades[storageKey] || [];
                tableBody.innerHTML = '';
                students.forEach(studentName => {
                    const studentGradeData = currentGrades.find(g => g.nama === studentName) || { nama: studentName };
                    const finalGrade = calculateFinalGrade(studentGradeData);
                    tableBody.innerHTML += `
                        <tr class="bg-white border-b hover:bg-gray-50" data-student-name="${studentName}">
                            <td class="px-6 py-4 font-medium text-gray-900">${studentName}</td>
                            <td class="px-2 py-2"><input type="number" class="w-20 text-center border rounded py-1 grade-input" data-type="tugas" value="${studentGradeData.tugas || ''}" min="0" max="100"></td>
                            <td class="px-2 py-2"><input type="number" class="w-20 text-center border rounded py-1 grade-input" data-type="harian" value="${studentGradeData.harian || ''}" min="0" max="100"></td>
                            <td class="px-2 py-2"><input type="number" class="w-20 text-center border rounded py-1 grade-input" data-type="uts" value="${studentGradeData.uts || ''}" min="0" max="100"></td>
                            <td class="px-2 py-2"><input type="number" class="w-20 text-center border rounded py-1 grade-input" data-type="uas" value="${studentGradeData.uas || ''}" min="0" max="100"></td>
                            <td class="px-6 py-4 text-center font-bold text-lg ${finalGrade >= 75 ? 'text-green-600' : 'text-red-600'} final-grade">${finalGrade}</td>
                        </tr>`;
                });
            };
            
            const updateFinalGradeInRow = (rowElement) => {
                const grades = {};
                rowElement.querySelectorAll('.grade-input').forEach(input => { grades[input.dataset.type] = parseFloat(input.value) || 0; });
                const finalGradeCell = rowElement.querySelector('.final-grade');
                const finalGrade = calculateFinalGrade(grades);
                finalGradeCell.textContent = finalGrade;
                finalGradeCell.className = `px-6 py-4 text-center font-bold text-lg ${finalGrade >= 75 ? 'text-green-600' : 'text-red-600'} final-grade`;
            };
            
            classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>' + Object.keys(App.masterData.siswa).map(c => `<option value="${c}">${c}</option>`).join('');
            subjectSelect.innerHTML = '<option value="">-- Pilih Mapel --</option>' + App.masterData.mapel.map(s => `<option value="${s}">${s}</option>`).join('');
            
            classSelect.addEventListener('change', render);
            subjectSelect.addEventListener('change', render);
            tableBody.addEventListener('input', (e) => { if (e.target.classList.contains('grade-input')) updateFinalGradeInRow(e.target.closest('tr')); });
            
            saveBtn.addEventListener('click', () => {
                const storageKey = `${classSelect.value}_${subjectSelect.value}`;
                if(!classSelect.value || !subjectSelect.value) {
                    App.helpers.showToast('Pilih kelas dan mapel terlebih dahulu!', 'error');
                    return;
                }
                const newGrades = [];
                tableBody.querySelectorAll('tr').forEach(row => {
                    const studentName = row.dataset.studentName;
                    if(studentName) {
                        const studentData = { nama: studentName };
                        row.querySelectorAll('.grade-input').forEach(input => { if(input.value) studentData[input.dataset.type] = parseFloat(input.value); });
                        newGrades.push(studentData);
                    }
                });
                allGrades[storageKey] = newGrades;
                save();
                App.helpers.showToast('Semua perubahan nilai berhasil disimpan!');
            });
            
            render();
        });
    </script>
</body>
</html>
